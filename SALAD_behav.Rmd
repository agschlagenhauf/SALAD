---
title: "SALAD Analyses in R"
author: "Lara Wieland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fig_caption: yes
---


This script 
- loads necessary packages
- imports data (dat for full sample and data for HC sample)
- recruits preps-subscripts for 1) preparing aggregated variable names (prep_agg) and 2) transforming to long (longtowide_agg)
- reproduces Zsuzsi's analyses on the SALAD dataset (descriptive only)
- adds repeated measures ANOVA for all main outcome variables + respective plots
- plots interindividual differences for p_correct


```{r, include = FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=8, fig.path='Figs/')
```

### Load packages

```{r, include=FALSE}
rm(list = ls()) 

if (!require(ggplot2)) install.packages("ggplot2")
if (!require(ggpubr)) install.packages("ggpubr")
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(psych)) install.packages("psych")
if (!require(car)) install.packages("car")
if (!require(lme4)) install.packages("lme4")
if (!require(reshape2)) install.packages("reshape2")
if (!require(ez)) install.packages("ez")
if (!require(broom)) install.packages("broom")
if (!require(strex)) install.packages("strex")
if (!require(nlme)) install.packages("nlme")
if (!require(lattice)) install.packages("lattice")
if (!require(tinytex)) install.packages('tinytex')
if (!require(reshape2)) install.packages('reshape2')
if (!require(sjmisc)) install.packages('sjmisc')



library("ggplot2")
library("ggpubr")
library("tidyverse")
library("psych")
library("car")
library("lme4")
library("reshape2")
library("ez")
library("broom")
library("strex")
library("nlme")
library("lattice")
library("tinytex")
library("sjmisc")

```

# Data Import
```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST: 
load('/cloud/project/dataframes/dat.nooutlier.rda')

```

# Aggregated Data Prep
```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST (if it does not work try uninstalling plyr or reshape2)
#detach("package:reshape2", unload=TRUE)
source('preps/prep_agg.R')

```


```{r}
# plot underlying task structure for BCCN poster

state_rev <- c(1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1, 1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2, 2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2)

state_rev_2 <- replace(state_rev, state_rev==2, 0)

plot(state_rev_2,type = "o", col = "black", xlab = "Trial", ylab = "Outcome probability", main = "Contingencies")


```

### Demographics and NP - Descriptive Stats and T-Tests between groups
```{r, include=FALSE}

# These reproduced Zsuzsi's results: significant differences between groups in age and education, IQ_WST, num_forward, num_backward and DSST

by(dat_all$age, dat_all$group, mean)
# by(dat_all$age, dat_all$group, sd)
t.test(age ~ group, data=dat_all)

by(dat_all$education, dat_all$group, mean)
# by(dat_all$education, dat_all$group, sd)
t.test(education ~ group, data=dat_all)

by(dat_all$weight, dat_all$group, mean)
# by(dat_all$weight, dat_all$group, sd)
t.test(weight ~ group, data=dat_all)

# for IQ with dat_all_complete due to some NAs
#by(dat_all_complete$IQ_WST, dat_all_complete$group, mean)
# by(dat_all$IQ_WST, dat_all$group, sd)
#t.test(IQ_WST ~ group, data=dat_all_complete)

by(dat_all$num_forward, dat_all$group, mean)
# by(dat_all$num_forward, dat_all$group, sd)
t.test(num_forward ~ group, data=dat_all)

by(dat_all$num_backward, dat_all$group, mean)
# by(dat_all$num_backward, dat_all$group, sd)
t.test(num_backward ~ group, data=dat_all)

by(dat_all$tmt_a, dat_all$group, mean)
# by(dat_all$tmt_a, dat_all$group, sd)
t.test(tmt_a ~ group, data=dat_all)

by(dat_all$tmt_b, dat_all$group, mean)
# by(dat_all$tmt_b, dat_all$group, sd)
t.test(tmt_b ~ group, data=dat_all)

by(dat_all$dsst, dat_all$group, mean)
# by(dat_all$dsst, dat_all$group, sd)
t.test(dsst ~ group, data=dat_all)

```

```{r, include=FALSE}
## NECESSARY TO RUN THIS FOR LATER RMANOVA ANALYSES (all markdowns in analyses folder)
source('preps/prep_agg.R')

```

```{r, include=FALSE}
## NECESSARY TO RUN THIS FOR LATER RMANOVA ANALYSES (all markdowns in analyses folder)
source('preps/longtowide_agg.R')

```


**Study design**
Within subject repeated measure: cond Stress(ST)/Control(CT)
Within subject measure: volat/phase (pre/rev/post) of Reversal Learning Task

### rmANOVA p_correct: 
1. for HC sample only main effect of volat, a non-significant interaction of volat * cond
2. for AD sample: here the volat * cond interaction stays significant as reflected in plot
3. for whole sample: main effect for volat and group, trendwise interaction effect
```{r,error=FALSE,warning=FALSE}

# now ezANOVA can be filled with dv = p_correct, within-variables = volat(phase) and cond, between-variable = group and type 3 sums of squares

# first for HC only: 
res.HC.correct <- ezANOVA(longdat.HC.correct, p_correct, id, within = .(volat,cond), detailed = TRUE, type = 3)
res.HC.correct

# then for AD only: 
res.AD.correct <- ezANOVA(longdat.AD.correct, p_correct, id, within = .(volat,cond), detailed = TRUE, type = 3)
res.AD.correct

# now for whole sample without covariates
res.correct <- ezANOVA(longdat.correct, p_correct, id, within = .(volat,cond), between = .(group), detailed = TRUE, type = 3)
# now with school years and age as covariates
res.correct.wcov <- ezANOVA(longdat.correct, p_correct, id, within = .(volat,cond), between = .(group), between_covariates = .(school_yrs,age), detailed = TRUE, type = 3)


# and make it look nicer
anova_out(res.correct.wcov)
anova_out(res.HC.correct)

# make a boxplot to take a look at distribution of p_correct group and phasewise
# panels show different groups
ggplot(longdat.correct, aes(x=phase, y=p_correct)) + geom_boxplot() + facet_grid(cols = vars(group))

# plot rmANOVA in two panels (AD and HC) with within-factors volat (pre, rev, post) and cond(ST vs. CT)
fig1.bycond.pcorrect <- ezPlot(
   data = longdat.correct
   , dv = .(p_correct)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(group)
   , col = .(cond)
   , y_lab = "p_correct"
   , split_lab = "Group"
)

ggsave(fig1.bycond.pcorrect, filename = "perc_pcorrect_cond.png","jpg", "/cloud/project/plots/behav_plots")

fig1.bygroup.pcorrect <- ezPlot(
   data = longdat.correct
   , dv = .(p_correct)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(cond)
   , col = .(group)
   , y_lab = "p_correct"
   , split_lab = "Condition"
)


ggsave(fig1.bygroup.pcorrect, filename = "perc_pcorrect_group.png","jpg", "/cloud/project/plots/behav_plots")

# plot subjectwise trajectories across all volat phases in both conditions
xyplot(p_correct ~ volat1  | sub_id, groups=cond,auto.key = TRUE, data=longdat.correct, type='b')


```

## rmANOVA Model p_correct
```{r}

# predict p_correct only from intercept, 2 repeated measure factors (volat and cond2) are nested within participant (id)
basmod <- lme(p_correct ~ 1,data = longdat.correct, random = ~1|id/volat/cond2, method = "ML")

mod <- lme(p_correct ~ volat, random = ~1|id/volat/cond2,data = longdat.correct, method = "ML")

# main effects
groupmod <- update(basmod, .~. + group)
volatmod <- update(groupmod, .~. + volat)
condmod <- update(volatmod, .~. + cond2)

# 2-way interactions
group_volat <- update(condmod, .~. + group:volat)
group_cond <- update(group_volat, .~. + group:cond2)
volat_cond <- update(group_cond, .~. + volat:cond2)

# 3-way interactions
group_volat_cond <- update(volat_cond, .~. + group:volat:cond2)

# compare models with anova
anova(basmod, mod, groupmod, volatmod, condmod, group_volat, group_cond, volat_cond, group_volat_cond)

#plot for BCCN poster - line plot on main outcome variables + error bars
figure1 <- ggplot(longdat.HC.correct, aes(x = volat,y = p_correct, col = cond)) + stat_summary(fun = mean, geom = "point") + stat_summary(fun = mean, geom = "line", aes(group = cond)) + stat_summary(fun.data = mean_se, geom = "errorbar",width = 0.2, aes(group = cond)) + labs(y= "Percentage Correct", x = "Phase") +
  theme(
        panel.grid.major = element_line(colour = "lightgrey"),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = 'white'),
        )

ggsave(figure1, filename = "perc_correct_HC.png","jpg", "/cloud/project/plots/behav_plots")

```

## rmANOVA p_stay
```{r, include=FALSE,error=FALSE,warning=FALSE}

# now ezANOVA can be filled with dv = p_stay, within-variable = cond, between-variable = group and type 3 sums of squares

res.stay <- ezANOVA(longdat.stay, p_stay, id, within = .(volat,cond), between = .(group), detailed = TRUE, type = 3)

# and make it look nicer
anova_out(res.stay)

# make a boxplot to take a look at distribution of p_stay group and phasewise
# panels show different groups
ggplot(longdat.stay, aes(x=phase, y=p_stay)) + geom_boxplot() + facet_grid(cols = vars(group))

# plot rmANOVA in two panels (AD and HC) with within-factors volat (pre, rev, post) and cond(ST vs. CT)
ezPlot(
   data = longdat.stay
   , dv = .(p_stay)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(cond)
   , col = .(group)
   , y_lab = "p_stay"
   , split_lab = "Condition"
)

# plot subjectwise trajectories across all volat phases in both conditions
xyplot(p_stay ~ volat  | sub_id, groups=cond,auto.key = TRUE, data=longdat.stay, type='b')

```

## rmANOVA p_sw
```{r, include=FALSE,error=FALSE,warning=FALSE}

# now ezANOVA can be filled with dv = p_switch, within-variable = cond, between-variable = group and type 2 sums of squares

# first for HC only
res.HC.sw <- ezANOVA(longdat.HC.sw, p_switch, id, within = .(volat,cond), detailed = TRUE, type = 3)

# now for whole sample
res.sw <- ezANOVA(longdat.sw, p_switch, id, within = .(volat,cond), between = .(group),between_covariates = .(school_yrs), detailed = TRUE, type =3)

# and make it look nicer
anova_out(res.sw)

# make a boxplot to take a look at distribution of p_switch group and phasewise
# panels show different groups
ggplot(longdat.sw, aes(x=phase, y=p_switch)) + geom_boxplot() + facet_grid(cols = vars(group))

# plot rmANOVA in two panels (AD and HC) with within-factors volat (pre, rev, post) and cond(ST vs. CT)
ezPlot(
   data = longdat.sw
   , dv = .(p_switch)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(cond)
   , col = .(group)
   , y_lab = "p_switch"
   , split_lab = "Condition"
)

# plot subjectwise trajectories across all volat phases in both conditions
xyplot(p_switch ~ volat1  | sub_id, groups=cond,auto.key = TRUE, data=longdat.sw, type='b')

```

## rmANOVA p_lswitch
```{r, include=FALSE,error=FALSE,warning=FALSE}

# now ezANOVA can be filled with dv = p_lswitch, within-variable = cond, between-variable = group and type 3 sums of squares

res.lswitch <- ezANOVA(longdat.lswitch, p_lswitch, id, within = .(volat,cond), between = .(group), detailed = TRUE, type = 3)

res.HC.lswitch <- ezANOVA(longdat.HC.lswitch, p_lswitch, id, within = .(volat,cond),between_covariates = .(school_yrs,age), detailed = TRUE, type = 3)

res.lswitch.wcov <- ezANOVA(longdat.lswitch, p_lswitch, id, within = .(volat,cond), between = .(group), between_covariates = .(school_yrs,age), detailed = TRUE, type = 3)

# and make it look nicer
anova_out(res.HC.lswitch)

# make a boxplot to take a look at distribution of p_lswitch group and phasewise, panels show different groups
ggplot(longdat.lswitch, aes(x=phase, y=p_lswitch)) + geom_boxplot() + facet_grid(group ~.)

# plot rmANOVA in two panels (AD and HC) with within-factors volat (pre, rev, post) and cond(ST vs. CT)
fig3.bycond.plswitch <- ezPlot(
   data = longdat.lswitch
   , dv = .(p_lswitch)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(group)
   , col = .(cond)
   , y_lab = "p_lswitch"
   , split_lab = "Group"
)

ggsave(fig3.bycond.plswitch, filename = "perc_lswitch_cond.png","jpg", "/cloud/project/plots/behav_plots")

ave(longdat.HC.lswitch$p_lswitch,longdat.HC.correct$cond, FUN=sd)
tapply(longdat.HC.lswitch$p_lswitch, longdat.HC.correct$cond, sd)

#plot for BCCN poster - line plot on main outcome variables + error bars
figure3 <- ggplot(longdat.HC.lswitch, aes(x = volat,y = p_lswitch, col = cond)) + stat_summary(fun = mean, geom = "point") + stat_summary(fun = mean, geom = "line", aes(group = cond)) + stat_summary(fun.data = mean_se, geom = "errorbar",width = 0.2, aes(group = cond))+ labs(y= "Percentage Lose Switch", x = "Phase") +
    theme(
        panel.grid.major = element_line(colour = "#b7d8db"),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = 'white'),
        )

ggsave(figure3, filename = "perc_lswitch_HC.png","jpg", "/cloud/project/plots/behav_plots")

```

## rmANOVA p_winstay
1. for HC sample only main effect of volat, a non-significant interaction of volat*cond
2. for AD sample: neither a main effect of volat nor an interaction of volat * cond
3. for whole sample: no main effect of group, trendwise main effect of volat, significant volat * cond * group interaction
```{r, include=FALSE,error=FALSE,warning=FALSE}
# now ezANOVA can be filled with dv = p_correct, within-variables = volat(phase) and cond, between-variable = group and type 3 sums of squares

# first for HC only: only main effect for volat, a non-significant interaction for volat*cond
res.HC.winstay <- ezANOVA(longdat.HC.winstay, p_winstay, id, within = .(volat,cond),between_covariates = .(school_yrs,age), detailed = TRUE, type = 3)
res.HC.winstay

# then for AD only: a non-significant main effect for volat and interaction for volat*cond
res.AD.winstay <- ezANOVA(longdat.AD.winstay, p_winstay, id, within = .(volat,cond), detailed = TRUE, type = 3)
res.AD.winstay

# now for the whole sample
res.winstay <- ezANOVA(longdat.winstay, p_winstay, id, within = .(volat,cond), between = .(group), detailed = TRUE, type = 3)
# now with school years and age as covariates
res.winstay.wcov <- ezANOVA(longdat.winstay, p_winstay, id, within = .(volat,cond), between = .(group), between_covariates = .(school_yrs,age), detailed = TRUE, type = 3)


# and make it look nicer
anova_out(res.HC.winstay)
anova_out(res.winstay.wcov)

# make a boxplot to take a look at distribution of p_winstay group and phasewise
# panels show different groups
ggplot(longdat.sw, aes(x=phase, y=p_switch)) + geom_boxplot() + facet_grid(cols = vars(group))

# plot rmANOVA in two panels (AD and HC) with within-factors volat (pre, rev, post) and cond(ST vs. CT)
fig1.bycond.pwinstay <- ezPlot(
   data = longdat.winstay
   , dv = .(p_winstay)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(group)
   , col = .(cond)
   , y_lab = "p_winstay"
   , split_lab = "Group"
)

ggsave(fig1.bycond.pwinstay, filename = "perc_wstay_cond.png","jpg", "/cloud/project/plots/behav_plots")

fig1.bygroup.pwinstay <- ezPlot(
   data = longdat.winstay
   , dv = .(p_winstay)
   , wid = .(id)
   , within = .(volat,cond)
   , between = .(group)
   , x = .(volat)
   , split = .(cond)
   , col = .(group)
   , y_lab = "p_winstay"
   , split_lab = "Condition"
)

ggsave(fig1.bygroup.pwinstay, filename = "perc_wstay_group.png","jpg", "/cloud/project/plots/behav_plots")

# plot subjectwise trajectories across all volat phases in both conditions
xyplot(p_winstay ~ volat1  | sub_id, groups=cond,auto.key = TRUE, data=longdat.winstay, type='b')

```
## rmANOVA Model p_winstay
```{r, include=FALSE,error=FALSE,warning=FALSE}

# predict p_winstay only from intercept, 2 repeated measure factors (volat and cond2) are nested within participant (id)
basmod <- lme(p_winstay ~ 1,data = longdat.winstay, random = ~1|id/volat/cond2, method = "ML")

# 
mod <- lme(p_winstay ~ volat, random = ~1|id/volat/cond2,data = longdat.winstay, method = "ML")

# main effects
groupmod <- update(basmod, .~. + group)
volatmod <- update(groupmod, .~. + volat)
condmod <- update(volatmod, .~. + cond2)

# 2-way interactions
group_volat <- update(condmod, .~. + group:volat)
group_cond <- update(group_volat, .~. + group:cond2)
volat_cond <- update(group_cond, .~. + volat:cond2)

# 3-way interactions
group_volat_cond <- update(volat_cond, .~. + group:volat:cond2)

# compare models with anova
anova(basmod, mod, groupmod, volatmod, condmod, group_volat, group_cond, volat_cond, group_volat_cond)

#plot for BCCN poster - line plot on main outcome variables + error bars

figure2 <- ggplot(longdat.HC.winstay, aes(x = volat,y = p_winstay, col = cond)) + stat_summary(fun = mean, geom = "point") + stat_summary(fun = mean, geom = "line", aes(group = cond)) + stat_summary(fun.data = mean_se, geom = "errorbar",width = 0.2, aes(group = cond))+ labs(y= "Percentage Win Stay", x = "Phase") +
    theme(
        panel.grid.major = element_line(colour = "#b7d8db"),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = 'white'),
        )

ggsave(figure2, filename = "perc_wstay_HC.png","jpg", "/cloud/project/plots/behav_plots")


```

## rmANOVA Reaction Times
1. for HC sample no main effect of volat, a significant interaction of volat * cond
2. for AD sample: neither a main effect of volat nor an interaction of volat * cond
3. for whole sample: no main effect of group, no main effect of volat, significant volat * cond * group interaction
```{r, include=FALSE,error=FALSE,warning=FALSE}

# now ezANOVA can be filled with dv = p_RT, within-variables = volat(phase) and cond, between-variable = group and type 3 sums of squares

# first for HC only
res.HC.RT <- ezANOVA(longdat.HC.RT, p_RT, id, within = .(volat,cond), detailed = TRUE, type = 3)

# first for HC only
res.AD.RT <- ezANOVA(longdat.AD.RT, p_RT, id, within = .(volat,cond), detailed = TRUE, type = 3)

# now for whole sample
res.RT <- ezANOVA(longdat.RT, p_RT, id, within = .(volat,cond), between = .(group), between_covariates = .(age), detailed = TRUE, type = 3)

# and make it look nicer
anova_out(res.HC.RT)

# make a boxplot to take a look at distribution of RT group and phasewise, panels show different group
ggplot(longdat.RT, aes(x=phase, y=p_RT)) + geom_boxplot() + facet_grid(cols = vars(group))

p.agg.RT <- ezPlot(
   data = longdat.HC.RT
   , dv = .(p_RT)
   , wid = .(id)
   , within = .(volat,cond)
   , x = .(volat)
   , split = .(cond)
   , y_lab = "Reaction Times"
   , split_lab = "Condition"
)

p.agg.RT

xyplot(p_RT ~ volat1  | sub_id, groups=cond,auto.key = TRUE, data=longdat.RT, type='b')

```
## rmANOVA Model p_RT
```{r}

# predict p_winstay only from intercept, 2 repeated measure factors (volat and cond2) are nested within participant (id)
basmod <- lme(p_RT ~ 1,data = longdat.RT, random = ~1|id/volat/cond2, method = "ML")

# 
mod <- lme(p_RT ~ volat, random = ~1|id/volat/cond2,data = longdat.RT, method = "ML")

# main effects
groupmod <- update(basmod, .~. + group)
volatmod <- update(groupmod, .~. + volat)
condmod <- update(volatmod, .~. + cond2)

# 2-way interactions
group_volat <- update(condmod, .~. + group:volat)
group_cond <- update(group_volat, .~. + group:cond2)

# 3-way interactions
group_volat_cond <- update(group_cond, .~. + group:volat:cond2)

# compare models with anova
anova(basmod, mod, groupmod, volatmod, condmod, group_volat, group_cond, group_volat_cond)

ggplot(longdat.RT, aes(x = volat,y = p_RT, col = cond)) + stat_summary(fun = mean, geom = "point") + stat_summary(fun = mean, geom = "line", aes(group = cond)) + facet_grid(group ~.)

```

## Preparing plots of intraindividual differences: make data_all wide + add VOIs
```{r}
# for whatever reason dat_all is not numeric so make it numeric first
data_all[,6:65] <- sapply(data_all[,6:65],as.numeric)

# calculate the difference between individual values (ST-CT) for single phases and all
data_all <- mutate(data_all, delta_STCT_pre = p_correct_pre_ST - p_correct_pre_CT)
data_all <- mutate(data_all,m_delta_STCT_pre = mean(delta_STCT_pre))

data_all <- mutate(data_all, delta_STCT_rev = p_correct_rev_ST - p_correct_rev_CT)
data_all <- mutate(data_all,m_delta_STCT_rev = mean(delta_STCT_rev))

data_all <- mutate(data_all, delta_STCT_post = p_correct_post_ST - p_correct_post_CT)
data_all <- mutate(data_all,m_delta_STCT_post = mean(delta_STCT_post))

data_all <- mutate(data_all, delta_STCT = p_correct_ST - p_correct_CT)
data_all <- mutate(data_all,m_delta_STCT = mean(delta_STCT))

data_all$group <- as.factor(data_all$group)
data_all$order <- as.factor(data_all$order)

#load('/cloud/project/dataframes/data.voi.rda')

# turn it into wide format by condition
melted <- melt(dat.voi, id.vars= c("sub_id", "cond"))
widedat.voi <- dcast(melted,  sub_id ~ variable + cond)

widedat.data.voi <- widedat.voi %>% right_join(data_all, by="sub_id")

widedat.data.voi <- mutate(widedat.data.voi, delta_Vstr = meanact_Vstr_ST - meanact_Vstr_CT)
widedat.data.voi <- mutate(widedat.data.voi, delta_nacc = meanact_nacc_ST - meanact_nacc_CT)

```


## Plots of delta p_correct and delta VOI
```{r}
plot.vstr.delta  <- ggscatter(widedat.data.voi, x = "delta_Vstr", y = "delta_STCT",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Ventral striatum activation (ST-CT)", ylab = "∆ Percentage correct responses (ST-CT)") 
plot.vstr.delta

ggsave(plot.vstr.delta, filename = "plot.vstr.delta","jpg", "/cloud/project/plots/meeting_plots")

plot.nacc.delta  <- ggscatter(widedat.data.voi, x = "delta_nacc", y = "delta_STCT",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Nucleus accumbens activation  (ST-CT)", ylab = "∆ Percentage correct responses (ST-CT)") 
plot.nacc.delta

ggsave(plot.nacc.delta, filename = "plot.nacc.delta","jpg", "/cloud/project/plots/meeting_plots")

```


## Plots of scaling and VOI
```{r}
plot.vstr.scalingw  <- ggscatter(widedat.data.voi, x = "delta_Vstr", y = "sc_win",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Ventral striatum activation (ST-CT)", ylab = "Scaling Win") 
plot.vstr.scalingw

ggsave(plot.vstr.scalingw, filename = "plot.vstr.scalingw","jpg", "/cloud/project/plots/meeting_plots")

plot.vstr.scalingl  <- ggscatter(widedat.data.voi, x = "delta_Vstr", y = "sc_loss",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Ventral striatum activation (ST-CT)", ylab = "Scaling Loss") 
plot.vstr.scalingl

ggsave(plot.vstr.scalingl, filename = "plot.vstr.scalingl","jpg", "/cloud/project/plots/meeting_plots")

plot.nacc.scalingw  <- ggscatter(widedat.data.voi, x = "delta_nacc", y = "sc_win",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Nucleus accumbens activation (ST-CT)", ylab = "Scaling Win") 
plot.nacc.scalingw

ggsave(plot.nacc.scalingw, filename = "plot.nacc.scalingw","jpg", "/cloud/project/plots/meeting_plots")

plot.nacc.scalingl  <- ggscatter(widedat.data.voi, x = "delta_nacc", y = "sc_loss",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Nucleus accumbens activation (ST-CT)", ylab = "Scaling Loss") 
plot.nacc.scalingl

ggsave(plot.nacc.scalingl, filename = "plot.nacc.scalingl","jpg", "/cloud/project/plots/meeting_plots")

```



## Plots of deltas (beta+scaling and VOI)
```{r}


plot.vstr.scalbetw  <- ggscatter(widedat.data.voi, x = "delta_Vstr", y = "sc_bet_win",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Ventral striatum activation (ST-CT)", ylab = "Scaling + Beta Win") 
plot.vstr.scalbetw

ggsave(plot.vstr.scalbetw, filename = "plot.vstr.scalingw","jpg", "/cloud/project/plots/meeting_plots")

plot.vstr.scalbetl  <- ggscatter(widedat.data.voi, x = "delta_Vstr", y = "sc_bet_loss",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Ventral striatum activation (ST-CT)", ylab = "Scaling + Beta Loss") 
plot.vstr.scalbetl

ggsave(plot.vstr.scalbetl, filename = "plot.vstr.scalingl","jpg", "/cloud/project/plots/meeting_plots")

plot.nacc.scalbetw  <- ggscatter(widedat.data.voi, x = "delta_nacc", y = "sc_bet_win",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Nucleus accumbens activation (ST-CT)", ylab = "Scaling + Beta Win") 
plot.nacc.scalbetw

ggsave(plot.nacc.scalbetw, filename = "plot.nacc.scalingw","jpg", "/cloud/project/plots/meeting_plots")

plot.nacc.scalbetl  <- ggscatter(widedat.data.voi, x = "delta_nacc", y = "sc_bet_loss",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "∆ Nucleus accumbens activation (ST-CT)", ylab = "Scaling + Beta Loss") 
plot.nacc.scalbetl

ggsave(plot.nacc.scalbetl, filename = "plot.nacc.scalingl","jpg", "/cloud/project/plots/meeting_plots")

```

## Plots of deltas (p_correct and vOI)
```{r}

plot.interindiv.delta <- ggplot(data_all, aes(x=group, y=delta_STCT)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) +
   xlab("Group") + ylab("Differences between ST and CT Condition") 
plot.interindiv.delta

ggplot(data_all, aes(x=group, y=delta_STCT_pre)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) 

ggplot(data_all, aes(x=group, y=delta_STCT_post)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) 

ggplot(data_all, aes(x=group, y=delta_STCT_pre, color=order)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0))

# dichotomize HC dataset by learning under stress (delta of ST-CT)
data_all$STlearning <- dicho(data_all$delta_STCT, dich.by = 0, as.num = TRUE)

data_dich_delta <- cbind(data_all$STlearning,data_all$sub_id)

data_dich_delta <- as.data.frame(data_dich_delta)
```

## Prepare plots with conditionwise separation (e.g. p_correct_CT with VOI_CT)
```{r}

# by cond
longdat.data_all <- melt(widedat.data.voi, id.vars=c("sub_id","order","age","weight","height","education","tmt_a","tmt_b","dsst","num_forward","num_backward","BIS_total","IQ_WST","school_yrs","al_win","al_loss","bet_win","bet_loss","sc_bet_win","sc_bet_loss","sc_loss","sc_win","delta_STCT","delta_STCT_pre","delta_STCT_rev","delta_STCT_post","delta_Vstr","delta_nacc"),
                           # The source columns
measure.vars=c("p_correct_ST","p_correct_CT"),
variable.name="cond",
value.name="p_correct"
)

# by phase for delta
longdat.phase.data_all <- melt(widedat.data.voi, id.vars=c("sub_id","order","age","weight","height","education","tmt_a","tmt_b","dsst","num_forward","num_backward","BIS_total","IQ_WST","school_yrs","al_win","al_loss","bet_win","bet_loss","sc_bet_win","sc_bet_loss","sc_loss","sc_win","delta_STCT","delta_Vstr","delta_nacc"),
                           # The source columns
measure.vars=c("delta_STCT_pre","delta_STCT_rev","delta_STCT_post"),
variable.name="phase",
value.name="delta_correct"
)


longdat.data_all$cond <- factor(longdat.data_all$cond,levels=rev(levels(longdat.data_all$cond)))

dat.voi$cond <- factor(dat.voi$cond)
longdat.data_all$cond <- plyr::revalue(longdat.data_all$cond , c("p_correct_CT" = "CT","p_correct_ST"="ST"))

longdat.data.voi <- dat.voi %>% right_join(longdat.data_all, by=c("sub_id","cond"))


```

## Plots with conditionwise separation (e.g. p_correct_CT with VOI_CT)
```{r}
# P_correct and VOI conditions separate

voi_plot_1 <- ggscatter(longdat.data.voi, x = "meanact_Vstr", y = "p_correct", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation ventral striatum", ylab = "Correct responses") + facet_wrap("cond")
voi_plot_1

voi_plot_2 <- ggscatter(longdat.data.voi, x = "meanact_nacc", y = "p_correct", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation nucleus accumbens", ylab = "Correct responses") + facet_wrap("cond")
voi_plot_2

# Modeling + VOI

voi_plot_3a <- ggscatter(longdat.data.voi, x = "meanact_nacc", y = "sc_bet_win", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation nucleus accumbens", ylab = "Scaling Beta Win") + facet_wrap("cond")
voi_plot_3

ggsave(voi_plot_3a, filename = "f3a_results.png","jpg", "/cloud/project/plots/committee_plots")

voi_plot_3b <- ggscatter(longdat.data.voi, x = "meanact_Vstr", y = "sc_bet_win", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation nucleus accumbens", ylab = "Scaling Beta Win") + facet_wrap("cond")
voi_plot_3b

ggsave(voi_plot_3b, filename = "f3a_results.png","jpg", "/cloud/project/plots/committee_plots")

voi_plot_4a <- ggscatter(longdat.data.voi, x = "meanact_Vstr", y = "sc_loss", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation nucleus accumbens", ylab = "Scaling Loss") + facet_wrap("cond")
voi_plot_4a

voi_plot_4b <- ggscatter(longdat.data.voi, x = "meanact_Vstr", y = "sc_win", color = "cond",
          add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson",
          xlab = "Mean activation nucleus accumbens", ylab = "Scaling Loss") + facet_wrap("cond")
voi_plot_4b

barplot.pcorrect <- ggbarplot(longdat.data_all, y = "p_correct", 
          add = c("mean_se", "jitter"),
          color = "cond", width=0.4, fill = c("#00BFC4","#F8766D"), alpha = 0.3,
          position = position_dodge(0.8)) +
   xlab("Condition") + ylab("Percentage of correct responses") +
   labs(title = 'Correct responses in raw data',  x = "", color = "Condition") +
   scale_color_manual(labels = c("Control", "Stress"), values = c("#00BFC4","#F8766D")) +
   theme(axis.text.x = element_blank()) +
   scale_y_continuous(expand = c(0,0)) 
barplot.pcorrect

longdat.phase.data_all$phase <- plyr::revalue(longdat.phase.data_all$phase, c("delta_STCT_pre" = "Pre-Reversal","delta_STCT_rev" ="Reversal","delta_STCT_post" ="Post Reversal"))

longdat.correct$volat <- plyr::revalue(longdat.correct$volat, c("pre" = "Pre-Reversal","rev" ="Reversal","post" ="Post Reversal"))

longdat.correct$cond <- factor(longdat.correct$cond,levels=rev(levels(longdat.correct$cond)))

barplot.pcorrect <- ggbarplot(data_all, y = "p_correct", x = "volat",
          color = "cond", width=0.4,alpha = 1,
          position = position_dodge(0.8)) +
   xlab("Condition") + ylab("Percentage of correct responses") +
   labs(title = 'Correct responses in raw data',  x = "", color = "Condition") +
   scale_fill_brewer(palette="BuPu") 
barplot.pcorrect

          add = c("mean_se", "jitter"),

boxplot.delta <- ggplot(data_all, aes(x=group, y=delta_STCT)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.2, height=0),size = 2) +
   xlab("Group") + ylab("∆ Correct responses Stress - Control (in %)") +
   labs(title = 'Interindividual differences',  x = "") +
    theme(
        panel.grid.major = element_line(colour = "darkgrey"),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = 'white'),
        ) +
   theme(axis.text.x = element_blank()) 
boxplot.delta

boxplot.delta.phase <- ggplot(longdat.phase.data_all, aes (x=phase,y=delta_correct,fill=phase)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.2, height=0),size = 2) +
   xlab("Phase") + ylab("∆ Correct responses Stress - Control (in %)") +
   labs(title = 'Interindividual learning differences by phase',  x = "") +
   scale_fill_brewer(palette="BuPu")
    theme(
        panel.grid.major = element_line(colour = "darkgrey"),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = 'white'),
        ) 
boxplot.delta.phase

ggsave(boxplot.delta.phase, filename = "boxplot.delta.phase.png","jpg", "/cloud/project/plots/meeting_plots")


f3_results <- ggarrange(barplot.pcorrect, boxplot.delta,
                    labels = c("A", "B"),
                    ncol = 2, nrow = 1)
f3_results

ggsave(f3_results, filename = "f3_results.png","jpg", "/cloud/project/plots/manuscript_plots")


```


