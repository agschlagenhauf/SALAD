---
title: "SALAD Analyses in R"
author: "Lara Wieland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script 
- loads packages
- imports data
- recruits subscripts for 1) preparing aggregated variable names (prep_agg) and 2) transforming to long (longtowide_agg)
- reproduces Zsuzsi's ** analyses on the SALAD dataset** (descriptive only):

**Study design**
Within subject repeated measure: cond Stress(ST)/Control(CT)
Within subject measure: volat/phase (pre/rev/post) of Reversal Learning Task
Between subject measure: group Alcohol Disorder (AD)/Healthy Controls (HC)


```{r, include = FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=8, fig.path='Figs/')
```



### Load packages

```{r, include=FALSE}
rm(list = ls()) 

if (!require(ggplot2)) install.packages("ggplot2")
if (!require(readxl)) install.packages("readxl")
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(psych)) install.packages("psych")
if (!require(car)) install.packages("car")
if (!require(lme4)) install.packages("lme4")
if (!require(reshape2)) install.packages("reshape2")
if (!require(ez)) install.packages("ez")
if (!require(broom)) install.packages("broom")
if (!require(strex)) install.packages("strex")
if (!require(nlme)) install.packages("nlme")
if (!require(lattice)) install.packages("lattice")
if (!require(tinytex)) install.packages('tinytex')
if (!require(purrr)) install.packages('purrr')
if (!require(knitr)) install.packages("knitr")
if (!require(kableExtra)) install.packages('kableExtra')
if (!require(stringr)) install.packages('stringr')
if (!require(hypr)) install.packages('hypr')
if (!require(schoRsch)) install.packages('schoRsch')
if (!require(hrbrthemes)) install.packages('hrbrthemes')
if (!require(emmeans)) install.packages('emmeans')
if (!require(psycho)) install.packages('psycho')
if (!require(gghalves)) install.packages('gghalves')
if (!require(sjPlot)) install.packages('sjPlot')
if (!require(sjmisc)) install.packages('sjmisc')
if (!require(effects)) install.packages('effects')
if (!require(sjstats)) install.packages('sjstats')
if (!require(cowplot)) install.packages('cowplot')
if (!require(ggpubr)) install.packages('ggpubr')
if (!require(foreign)) install.packages('foreign')

library("ggplot2")
library("readxl")
library("tidyverse")
library("psych")
library("car")
library("lme4")
library("reshape2")
library("ez")
library("broom")
library("strex")
library("nlme")
library("lattice")
library("tinytex")
library("purrr")
library("knitr")
library("kableExtra")
library("stringr")
library("hypr")
library('schoRsch')
library('hrbrthemes')
library('emmeans')
library('psycho')
library('gghalves')
library('sjPlot') #for plotting lmer and glmer mods
library('sjmisc') 
library('effects')
library('sjstats') #use for r2 functions
library('cowplot')
library("ggpubr")
library("foreign")

```

```{r}
# plot underlying task structure for BCCN poster

state_rev <- c(1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1, 1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2, 2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2)

state_rev_2 <- replace(state_rev, state_rev==2, 0)

plot(state_rev_2,type = "o", col = "black", xlab = "Trial", ylab = "Outcome probability", main = "Contingencies")


```

### Demographics and NP - Descriptive Stats and T-Tests between groups
The dataset corresponds to sample 1 and includes `r nrow(dat)` subjects, of whom `r nrow(dat.AD)` are AD and `r nrow(dat.HC)` HC.
```{r, include=FALSE}

# These reproduced Zsuzsi's results: significant differences between groups in age and education, IQ_WST, num_forward, num_backward and DSST

by(dat$age, dat$group, mean)
# by(dat$age, dat$group, sd)
t.test(age ~ group, data=dat)

by(dat$education, dat$group, mean)
# by(dat$education, dat$group, sd)
t.test(education ~ group, data=dat)

by(dat$weight, dat$group, mean)
# by(dat$weight, dat$group, sd)
t.test(weight ~ group, data=dat)

# for IQ with dat_complete due to some NAs
by(dat_complete$IQ_WST, dat_complete$group, mean)
# by(dat$IQ_WST, dat$group, sd)
#t.test(IQ_WST ~ group, data=dat_complete)

by(dat$num_forward, dat$group, mean)
# by(dat$num_forward, dat$group, sd)
t.test(num_forward ~ group, data=dat)

by(dat$num_backward, dat$group, mean)
# by(dat$num_backward, dat$group, sd)
t.test(num_backward ~ group, data=dat)

by(dat$tmt_a, dat$group, mean)
# by(dat$tmt_a, dat$group, sd)
t.test(tmt_a ~ group, data=dat)

by(dat$tmt_b, dat$group, mean)
# by(dat$tmt_b, dat$group, sd)
t.test(tmt_b ~ group, data=dat)

by(dat$dsst, dat$group, mean)
# by(dat$dsst, dat$group, sd)
t.test(dsst ~ group, data=dat)

mean.sum <- dat %>% group_by(group) %>% summarize(mean_age = mean(age))

options(knitr.kable.NA = "")
# then print it in a table using the kable command

kable(
  mean.sum,
  col.names = c("Groups", "Mean Age")
) %>%
  kable_styling("striped") %>%
  footnote("HC = Healthy Controls, AD = Alcoholic Disorder", general_title = "Demographic and neuropsychological data")
#####

```
The groups are significantly different regarding age, education, IQ (num_forward, num_backward, DSST)

```{r, include=FALSE}
## NECESSARY TO RUN THIS FOR LATER RMANOVA ANALYSES (all markdowns in analyses folder)
source('preps/prep_agg.R')

```

```{r, include=FALSE}
## NECESSARY TO RUN THIS FOR LATER RMANOVA ANALYSES (all markdowns in analyses folder)
source('preps/longtowide_agg.R')

```


## Plots of intraindividual differences
```{r}
# for whatever reason dat_all is not numeric so make it numeric first
dat_all[,6:65] <- sapply(dat_all[,6:65],as.numeric)

# calculate the difference between individual values (ST-CT) for single phases and all
dat_all <- mutate(dat_all, diff_STCT_pre = p_correct_pre_ST - p_correct_pre_CT)
dat_all <- mutate(dat_all,m_diff_STCT_pre = mean(diff_STCT_pre))

dat_all <- mutate(dat_all, diff_STCT_rev = p_correct_rev_ST - p_correct_rev_CT)
dat_all <- mutate(dat_all,m_diff_STCT_rev = mean(diff_STCT_rev))

dat_all <- mutate(dat_all, diff_STCT_post = p_correct_post_ST - p_correct_post_CT)
dat_all <- mutate(dat_all,m_diff_STCT_post = mean(diff_STCT_post))

dat_all <- mutate(dat_all, diff_STCT = p_correct_ST - p_correct_CT)
dat_all <- mutate(dat_all,m_diff_STCT = mean(diff_STCT))

dat_all$group <- as.factor(dat_all$group)
dat_all$order <- as.factor(dat_all$order)

ggplot(dat_all, aes(x=group, y=diff_STCT)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) 

ggplot(dat_all, aes(x=group, y=diff_STCT_pre)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) 

ggplot(dat_all, aes(x=group, y=diff_STCT_post)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0)) 

ggplot(dat_all, aes(x=group, y=diff_STCT_pre, color=order)) + 
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.1, height=0))

plot_pre_diff <- ggplot(dat_all, aes(sub_id, diff_STCT_pre)) +
  geom_point()
plot_pre_diff

plot_rev_diff <- ggplot(dat_all, aes(sub_id, diff_STCT_rev)) +
  geom_col()
plot_rev_diff

plot_post_diff <- ggplot(dat_all, aes(sub_id, diff_STCT_post)) +
  geom_col()
plot_post_diff

plot_diff <- ggplot(dat_all, aes(sub_id, diff_STCT)) +
  geom_col()
plot_diff



```

```{r}


## Correlations with cbm Modeling Parameters


mf1 <- ggscatter(data_all, x = "IQ_WST", y = "beta_win", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cognitive capacities", ylab = "Choice stochasticity (beta win)")
mf1

mf2 <- ggscatter(data_all, x = "IQ_WST", y = "beta_loss", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cognitive capacities", ylab = "Choice stochasticity (beta loss)")
mf2

mf3 <- ggscatter(data_all, x = "p_switch_ST", y = "BIS_total", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Switching behavior ST", ylab = "Impulsivity")
mf3

mf4 <- ggscatter(data_all, x = "p_lose_switch_ST", y = "kappa", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Switching behavior ST", ylab = "Updating (kappa)")
mf4

mf5 <- ggscatter(data_all, x = "p_lose_switch_CT", y = "kappa", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Switching behavior CT", ylab = "Updating (kappa)")
mf5

mf6 <- ggscatter(data_all, x = "p_win_stay_ST", y = "kappa", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Switching behavior ST", ylab = "Updating (kappa)")
mf6

mf7 <- ggscatter(data_all, x = "p_win_stay_CT", y = "kappa", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Switching behavior CT", ylab = "Updating (kappa)")
mf7
```

