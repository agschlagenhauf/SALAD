---
title: "SALAD Analyses in R - hierarchical/single-trial analyses"
author: "Lara Wieland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fig_caption: yes
---

This script:
- loads necessary packages
- imports data (data_new for full  sample, data_new_HC for only HC and excluding 1B057 who has an AUC Stress missing value)
- sets up contrasts for phase and condition
- sets up lmes for pcorrect, winstay, loseswitch, RT for HC and AD separately and together (only for HC sample final)
- conducts post-hoc tests on some of the winning models using emmip

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
rm(list = ls()) 

if (!require(ggplot2)) install.packages("ggplot2")
if (!require(lme4)) install.packages("lme4")
if (!require(hypr)) install.packages('hypr')
if (!require(schoRsch)) install.packages('schoRsch')
if (!require(emmeans)) install.packages('emmeans')
if (!require(psycho)) install.packages('psycho')
if (!require(sjPlot)) install.packages('sjPlot')
if (!require(sjmisc)) install.packages('sjmisc')
if (!require(effects)) install.packages('effects')
if (!require(sjstats)) install.packages('sjstats')
if (!require(parameters)) install.packages("parameters")
if (!require(insight)) install.packages("insight")
if (!require(broom.mixed)) install.packages("broom.mixed")
if (!require(lmerTest)) install.packages("lmerTest")


library("dplyr")
library("tidyr")
library("ggplot2")
library("lme4")
library("hypr") # for setting up contrasts
library('schoRsch') # for outputs in APA style
library('emmeans') # for post-hoc tests of lmer
library('psycho')
library('sjPlot') #for plotting lmer and glmer mods
library('sjmisc') 
library('effects') 
library('sjstats') #use for r2 functions
library("parameters") # nice PDF-friendly formatting of glm results
library("insight")
library("broom.mixed")
library("lmerTest")


```

# Data Import
```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST:
load('/cloud/project/dataframes/data_new_HC.rda')
load('/cloud/project/dataframes/data_prep.rda')
```

## Single Trial Analyses: Set Contrasts and Compare Models (only HC)
```{r}
# extract trials with RT = 0, because they are missings/NAN
which(!data_new_HC$RT == 0)
excl_row <- row(data_new_HC)[which(!data_new_HC$RT != 0)]

# calculate perc of trials excluded
perc_excl <- (length(excl_row)/nrow(data_new_HC))*100

# exclude trials with RT = 0 because they are NaN for w_stay and l_switch as well
data_new_HC <- data_new_HC %>% filter(RT!=0)

# create hypr object with resulting contrast matrix used below
volatContrast <- hypr(X1~X2, X1~X3)

# contrasts(data_new_HC$Group) <- c(0.5,-0.5)
contrasts(data_new_HC$Cond) <- c(-0.5,0.5)
contrasts(data_new_HC$volat) <- cbind(c1 = c(1/3,-2/3,1/3), c2 = c(1/3,1/3,-2/3))

# hypr object containing 2 null hypotheses, volat1 vs. volat2 and volat1 vs. volat3 while contrasts still add to 0:
# H0.1: 0 = X1 - X2
# H0.2: 0 = X1 - X3
# non-orthogonal contrasts because off diagonal ~= 0
# centered contrasts because c1 and c2 as columns add up to 0

# Cond factor: 1 = control, 2 = stress
# F1 (control) = -0.5, F2 (stress) = 0.5 which means that 
# eine Einheit von CT - ST wird durch Beta kodiert
# estim. value for F1 = Intercept - 0.5* Slope(F1) 1.13 = 1.19 - 0.5*0.12
# estim. value for F2 = Intercept + 0.5* Slope(F1) 1.25 = 1.19 + 0.5*0.12

###################################################################################################################
############################ building models consecutively  #######################################################

# CHANGE HERE scale zpeak_cort or zpeak_amyl or aucg variable to avoid convergence issues

data_new_HC$aucg_scaled <- scale(data_new_HC$aucg)
#data_new_HC$zpeak_scaled <- scale(data_new_HC$zpeak)
#data_new_HC$zpeak_scaled <- scale(data_new_HC$zpeak_amyl)

# use single trial dataset (data_new_HC) to predict Correct

# - in a model with Correct predicted by random subject intercept (0) + covariates (0a)
# - in a model with Correct predicted by random subject intercept + all main effects (1)
# - in a model with Correct predicted by random subject intercept + all main effects + 2-way-interaction effect (2)
mod0.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
mod0a.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.correct <- glmer(Correct~aucg_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.correct <- glmer(Correct~aucg_scaled*volat+(1|sub_idx), data=data_new_HC,family=binomial)

anova(mod0.HC.correct, mod0a.HC.correct,mod1.HC.correct,mod2.HC.correct)
# 
# mod1.HC.correct <- glmer(Correct~zpeak_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
# mod2.HC.correct <- glmer(Correct~zpeak_scaled*volat+(1|sub_idx), data=data_new_HC,family=binomial)

mod0.HC.cond.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
mod0a.HC.cond.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.cond.correct <- glmer(Correct~Cond+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.cond.correct <- glmer(Correct~Cond*volat+(1|sub_idx), data=data_new_HC,family=binomial)

anova(mod0.HC.cond.correct, mod0a.HC.cond.correct,mod1.HC.cond.correct,mod2.HC.cond.correct)

mod0.HC.both.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
mod0a.HC.both.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.both.correct <- glmer(Correct~Cond+aucg_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.both.correct <- glmer(Correct~Cond*aucg_scaled*volat+(1|sub_idx), data=data_new_HC,family=binomial)

anova(mod0.HC.both.correct, mod0a.HC.both.correct,mod1.HC.both.correct,mod2.HC.both.correct)

# mod0.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
# mod0a.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
# mod1.HC.correct <- glmer(Correct~zpeak_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
# mod2.HC.correct <- glmer(Correct~zpeak_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
# mod3.HC.correct <- glmer(Correct~Cond*volat*zpeak_scaled+(1|sub_idx), data=data_new_HC,family=binomial)
# upd3.HC.correct <- getME(mod2.HC.correct,c("theta","fixef"))
# mod3.HC.correct.upd <- update(mod2.HC.correct,start=upd3.HC.correct,control=glmerControl(optCtrl=list(maxfun=2e4)))

# model comparison of models predicting Correct
# here comparison only possible if everyone has a cortisol value (otherwise models do not rely on same sample)
# 1B057 is lacking T1_cort_ST and T1_amyl_ST (for this person extra calculation of AUC? T2 instead of T1, systematic bias? otherwise exclude) - Florian

# now display results in a manuscript-ready format

sjPlot::plot_model(mod1.HC.correct,show.values=TRUE, show.p=TRUE, axis.labels = c("Stable Phase","Reversal Phase","Cortisol Effect"))

set_theme(
  base = theme_light(),
  axis.title.size = 1,
  axis.textsize = 1,
  legend.size = 1,
  legend.title.size = 1,
  geom.label.size = 10
)

plot_model(mod1.HC.correct,show.values=TRUE, show.p=TRUE, title = "Odd's Ratio of winning fixed-effect model", axis.labels = c("Stable Phase","Reversal Phase","Condition Effect")) 
# + font_size(title =15, axis_title.x=10, labels.y=10) 

sjPlot::plot_model(mod1.HC.cond.correct,show.values=TRUE, show.p=TRUE, axis.labels = c("Stable Phase","Reversal Phase","Condition Effect"))

set_theme(
  base = theme_light(),
  axis.title.size = 0.5,
  axis.textsize = 1,
  legend.size = 1,
  legend.title.size = 1,
  geom.label.size = 5
)

OR_cond <- plot_model(mod1.HC.cond.correct,show.values=TRUE, show.p=TRUE, title = "Odd's Ratios of winning fixed-effect model", axis.labels = c("Stable Phase","Reversal Phase","Condition Effect")) 
# + font_size(title =15, axis_title.x=10, labels.y=10) 

save_plot(
  "OR_cond.svg",
  fig = last_plot(),
  width = 9,
  height = 9,
  dpi = 300,
  theme = theme_get(),
  label.color = "black",
)



sjPlot::tab_model(mod1.HC.correct, 
                  show.re.var= TRUE, 
                  pred.labels =c("Intercept", "AUC Cortisol (Stress)", "Reversal Phase", "Stable Phase"))

sjPlot::tab_model(mod1.HC.cond.correct, 
                  show.re.var= TRUE, 
                  pred.labels =c("Intercept", "Condition (Stress Day)", "Reversal Phase", "Stable Phase"))

sjPlot::plot_model(mod1.HC.cond.correct,show.values=TRUE, show.p=TRUE, auto.label = FALSE)

sjPlot::tab_model(mod1.HC.cond.correct, 
                  show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.stat = TRUE, show.df = TRUE,
                  pred.labels =c("Intercept", "Condition", "Reversal Phase", "Stable Phase"))

sjPlot::tab_model(mod1.HC.correct, 
                  show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.stat = TRUE, show.df = TRUE, show.re.var = FALSE,
                  pred.labels =c("Intercept", "AUC Cortisol (Stress)", "Reversal Phase", "Stable Phase"))


effects_Cond <- effects::effect(term= "Cond", mod= mod1.HC.cond.correct)
summary(effects_Cond) #output of what the values are
x_cond <- as.data.frame(effects_Cond)



# use single trial dataset (data_new_HC) to predict w_stay

# - in a model with w_stay predicted by random subject intercept (0) + covariates (0a)
# - in a model with w_stay predicted by random subject intercept + all main effects (1)
# - in a model with w_stay predicted by random subject intercept + all main effects + 2-way-interaction effect (2)
mod0.HC.wstay <- glmer(w_stay~(1|sub_idx), data=data_new_HC, family=binomial)
mod0a.HC.wstay <- glmer(w_stay~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.wstay <- glmer(w_stay~Cond+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.wstay <- glmer(w_stay~Cond*volat+(1|sub_idx), data=data_new_HC,family=binomial)

# model comparison of w_stay models
anova(mod0.HC.wstay,mod1.HC.wstay,mod2.HC.wstay)

# use single trial dataset (data_new_HC) to predict l_switch

# - in a model with l_switch predicted by random subject intercept (0) + covariates (0a)
# - in a model with l_switch predicted by random subject intercept + all main effects (1)
# - in a model with l_switch predicted by random subject intercept + all main effects + 2-way-interaction effect (2)

mod0.HC.lswitch <- glmer(l_switch~(1|sub_idx), data=data_new_HC, family=binomial)
mod0a.HC.lswitch <- glmer(l_switch~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.lswitch <- glmer(l_switch~Cond+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.lswitch <- glmer(l_switch~Cond*volat+(1|sub_idx), data=data_new_HC,family=binomial)

# model comparison of lswitch models
anova(mod0.HC.lswitch,mod0a.HC.lswitch,mod1.HC.lswitch,mod2.HC.lswitch)

# try out package for 
# library(fitdistrplus)
# library(glmmTMB)
# library(afex)

# for a given distribution estimate parameters and provide goodness-of-fit graphs
# plotdist(data_new_HC$RTms)

# provides a skewness-kurtosis graph to help to choose the best candidate(s) to fit a given dataset
# descdist(data_new_HC$RTms,boot = 1000)

# use single trial dataset (data_new_HC) to predict RT

# - in a model with l_switch predicted by random subject intercept (0) + covariates (0a)
# - in a model with l_switch predicted by random subject intercept + all main effects (1)
# - in a model with l_switch predicted by random subject intercept + all main effects + 2-way-interaction effect (2)


# logarithmize RT 
data_new_HC <- data_new_HC %>% rowwise() %>% mutate(RTlog10 = log10(RT*1000))
data_new_HC <- data_new_HC %>% rowwise() %>% mutate(RTlog = log(RT*1000))
data_new_HC <- data_new_HC %>% rowwise() %>% mutate(RTinv = 1/(RT*1000))

hist(data_new_HC$RTlog)
hist(data_new_HC$RTlog10)

hist(data_new_HC$RTinv)

# main effect of cond interaction between stable phase contrast (1 vs. 3) and condition
# with glmer and link function?
mod0.HC.cond.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
mod0a.HC.cond.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
mod1.HC.cond.RT <- lmer(RTlog~Cond+volat+(1|sub_idx), data=data_new_HC)
mod2.HC.cond.RT <- lmer(RTlog~Cond*volat+(1|sub_idx), data=data_new_HC)

anova(mod0.HC.cond.RT,mod0a.HC.cond.RT,mod1.HC.cond.RT,mod2.HC.cond.RT)


# same for cortisol 
mod0.HC.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
mod0a.HC.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
mod1.HC.RT <- lmer(RTlog~aucg_scaled+volat+(1|sub_idx), data=data_new_HC)
mod2.HC.RT <- lmer(RTlog~aucg_scaled*volat+(1|sub_idx), data=data_new_HC)

# model comparison of RT models
anova(mod0.HC.RT,mod0a.HC.RT,mod1.HC.RT,mod2.HC.RT)

# # and condition + cortisol 
# mod0.HC.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
# mod0a.HC.RT <- lmer(RTlog~(1|sub_idx), data=data_new_HC)
# mod1.HC.RT <- lmer(RTlog~Cond+aucg_scaled+volat+(1|sub_idx), data=data_new_HC)
# mod2.HC.RT <- lmer(RTlog~Cond*aucg_scaled*volat+(1|sub_idx), data=data_new_HC)

sjPlot::plot_model(mod2.HC.cond.RT,show.values=TRUE, show.p=TRUE, axis.labels = c("Condition*Stable","Condition*Reversal","Reversal Phase","Stable Phase","Condition Effect"))

sjPlot::tab_model(mod2.HC.cond.RT, 
                  show.re.var = TRUE, 
                  pred.labels = c("Intercept","Condition Effect","Reversal Phase","Stable Phase","Condition*Reversal","Condition*Stable"))

# I am not clear on why the axis labels are not in proper order but this is the only way it actually works and matches the figure
sjPlot::plot_model(mod2.HC.RT,show.values=TRUE, show.p=TRUE, axis.labels = c("Cortisol*Stable","Cortisol*Reversal","Reversal Phase","Stable Phase","Cortisol Effect"))

``` 

```{r}

# filter single trial dataset by healthy controls
data_new_AUD <- data_new %>% filter(Group == "AUD")

contrasts(data_new_AUD$Group) <- c(0.5,-0.5)
contrasts(data_new_AUD$Cond) <- c(0.5,-0.5)
contrasts(data_new_AUD$volat) <- cbind(c1 = c(1/3,-2/3,1/3), c2 = c(1/3,1/3,-2/3))

# hypr object containing 2 null hypotheses, volat1 vs. volat2 and volat1 vs. volat3 while contrasts still add to 0:
# H0.1: 0 = X1 - X2
# H0.2: 0 = X1 - X3

###################################################################################################################
############################ building models consecutively  #######################################################

# use single trial dataset (data_new_AUD) to predict Correct

# - in a model with Correct predicted by random subject intercept (0) + covariates (0a)
# - in a model with Correct predicted by random subject intercept + all main effects (1)
# - in a model with Correct predicted by random subject intercept + all main effects + 2-way-interaction effect (2)
mod0.AUD.correct <- glmer(Correct~(1|sub_idx), data=data_new_AUD, family=binomial)
mod0a.AUD.correct <- glmer(Correct~(1|sub_idx)+age, data=data_new_AUD,family=binomial)
mod1.AUD.correct <- glmer(Correct~Cond+volat+order+(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
mod2.AUD.correct <- glmer(Correct~Cond*volat*order+(1|sub_idx), data=data_new_AUD,family=binomial)
upd1.AUD.correct <- getME(mod2.AUD.correct,c("theta","fixef"))
mod2.AUD.correct.upd <- update(mod2.AUD.correct,start=upd1.AUD.correct,control=glmerControl(optCtrl=list(maxfun=2e4)))

# model comparison of models predicting Correct
anova(mod0.AUD.correct, mod0a.AUD.correct, mod1.AUD.correct,mod2.AUD.correct)

# use single trial dataset (data_new_AUD) to predict w_stay

# - in a model with w_stay predicted by random subject intercept (0) + covariates (0a)
# - in a model with w_stay predicted by random subject intercept + all main effects (1)
# - in a model with w_stay predicted by random subject intercept + all main effects + 2-way-interaction effect (2)
mod0.AUD.wstay <- glmer(w_stay~(1|sub_idx), data=data_new_AUD, family=binomial)
mod0a.AUD.wstay <- glmer(w_stay~(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
mod1.AUD.wstay <- glmer(w_stay~Cond+volat+(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
mod2.AUD.wstay <- glmer(w_stay~Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
upd2.AUD.wstay <- getME(mod2.AUD.wstay,c("theta","fixef"))
mod2.AUD.wstay.upd <- update(mod2.AUD.wstay,start=upd2.AUD.wstay,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=2e4)))

# model comparison of w_stay models
anova(mod0.AUD.wstay,mod0a.AUD.wstay,mod1.AUD.wstay,mod2.AUD.wstay)

# use single trial dataset (data_new_AUD) to predict l_switch

# - in a model with l_switch predicted by random subject intercept (0) + covariates (0a)
# - in a model with l_switch predicted by random subject intercept + all main effects (1)
# - in a model with l_switch predicted by random subject intercept + all main effects + 2-way-interaction effect (2)

mod0.AUD.lswitch <- glmer(l_switch~(1|sub_idx), data=data_new_AUD, family=binomial)
mod0a.AUD.lswitch <- glmer(l_switch~(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
mod1.AUD.lswitch <- glmer(l_switch~Cond+volat+(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
mod2.AUD.lswitch <- glmer(l_switch~Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new_AUD,family=binomial)
upd2.AUD.lswitch <- getME(mod2.AUD.lswitch,c("theta","fixef"))
mod2.AUD.lswitch.upd <- update(mod2.AUD.lswitch,start=upd2.AUD.lswitch,control=glmerControl(optCtrl=list(maxfun=2e4)))

# model comparison of lswitch models
anova(mod0.AUD.lswitch,mod0a.AUD.lswitch,mod1.AUD.lswitch,mod2.AUD.lswitch)


``` 

## Single Trial Analyses: Set Contrasts and Compare Models (AUD + HC)
```{r}
contrasts(data_new$Group) <- c(0.5,-0.5)
contrasts(data_new$Cond) <- c(0.5,-0.5)
contrasts(data_new$volat) <- cbind(c1 = c(1/3,-2/3,1/3), c2 = c(1/3,1/3,-2/3))

# hypr object containing 2 null hypotheses, volat1 vs. volat2 and volat1 vs. volat3 while contrasts still add to 0:
# H0.1: 0 = X1 - X2
# H0.2: 0 = X1 - X3

###################################################################################################################
############################ building models consecutively  #######################################################

# use single trial dataset (data_new) to predict Correct

# - in a model with Correct predicted by random subject intercept (0) + covariates (0a)
# - in a model with Correct predicted by random subject intercept + all main effects (1)
# - in a model with Correct predicted by random subject intercept + all main effects + 2-way-interaction effects (2)
# - in a model with Correct predicted by random subject intercept + all main effects + 3-way-interaction effects (3)

mod0.correct <- glmer(Correct~(1|sub_idx), data=data_new, family=binomial)
mod0a.correct <- glmer(Correct~(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
mod1.correct <- glmer(Correct~Group+Cond+volat+(1|sub_idx)+school_yrs, data=data_new,family=binomial)
mod2.correct <- glmer(Correct~Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
mod3.correct <- glmer(Correct~Group*Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd3.correct <- getME(mod3.correct,c("theta","fixef"))
mod3.correct.upd <- update(mod3.correct,start=upd3.correct,control=glmerControl(optCtrl=list(maxfun=2e4)))
# model comparison of Correct models
anova(mod0.correct, mod0a.correct,mod1.correct,mod2.correct,mod3.correct.upd)

# now display results in a manuscript-ready format
sjPlot::plot_model(mod2.correct)

sjPlot::tab_model(mod2.correct, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Stress", "Volatility", "Stability", "School Years", "Age", "Interaction of Stress and Reversal Phase", "Interaction of Stress and Stable Phase"),
                  dv.labels= "Effects of stress on correct responses")

# use single trial dataset (data_new) to predict w_stay

# - in a model with w_stay predicted by random subject intercept (0) + covariates (0a)
# - in a model with w_stay predicted by random subject intercept + all main effects (1)
# - in a model with w_stay predicted by random subject intercept + all main effects + 2-way-interaction effects (2)
# - in a model with w_stay predicted by random subject intercept + all main effects + 3-way-interaction effects (3)
## CONVERGENCE ISSUE FOR MOST COMPLEX MODEL 2 and 3 (despite trying out bobyqa, NELDER_MEAD and optimx)

mod0.wstay <- glmer(w_stay~(1|sub_idx), data=data_new, family=binomial)
mod0a.wstay <- glmer(w_stay~(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
mod1.wstay <- glmer(w_stay~Group+Cond+volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
mod2.wstay <- glmer(w_stay~Group*Cond+Group*volat+Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd2.wstay <- getME(mod2.wstay,c("theta","fixef"))
mod2.wstay.upd <- update(mod2.wstay,start=upd2.wstay,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))
mod3.wstay <- glmer(w_stay~Group*Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd3.wstay <- getME(mod3.wstay,c("theta","fixef"))
mod3.wstay.upd <- update(mod3.wstay,start=upd3.wstay,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=20e4)))

# model comparison of w_stay models
anova(mod0.wstay,mod0a.wstay,mod1.wstay,mod2.wstay.upd,mod3.wstay.upd)

# now display results in a manuscript-ready format
sjPlot::plot_model(mod3.wstay.upd,
                   show.values=TRUE, show.p=TRUE)

sjPlot::tab_model(mod3.wstay.upd, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)","AUD", "Stress", "Reversal Phase", "Stable Phase", "School Years", "Age", "Interaction of Stress and Reversal Phase", "Interaction of Stress and Stable Phase"),
                  dv.labels= "Effects of stress on win-stay behavior")

# use single trial dataset (data_new) to predict l_switch

# - in a model with l_switch predicted by random subject intercept (0) + covariates (0a)
# - in a model with l_switch predicted by random subject intercept + all main effects (1)
# - in a model with l_switch predicted by random subject intercept + all main effects + 2-way-interaction effects (2)
# - in a model with l_switch predicted by random subject intercept + all main effects + 3-way-interaction effects (3)
## CONVERGENCE ISSUE FOR MOST COMPLEX MODEL 2 and 3 (despite trying out bobyqa, NELDER_MEAD and optimx)

mod0.lswitch <- glmer(l_switch~(1|sub_idx), data=data_new, family=binomial)
mod0a.lswitch <- glmer(l_switch~(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
mod1.lswitch <- glmer(l_switch~Group+Cond+volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd1.lswitch <- getME(mod1.lswitch,c("theta","fixef"))
mod1.lswitch.upd <- update(mod1.lswitch,start=upd1.lswitch,control=glmerControl(optCtrl=list(maxfun=2e4)))
mod2.lswitch <- glmer(l_switch~Group*Cond+Group*volat+Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd2.lswitch <- getME(mod2.lswitch,c("theta","fixef"))
mod2.lswitch.upd <- update(mod2.lswitch,start=upd2.lswitch,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=20e4)))
mod3.lswitch <- glmer(l_switch~Group*Cond*volat+(1|sub_idx)+school_yrs+age, data=data_new,family=binomial)
upd3.lswitch <- getME(mod3.lswitch,c("theta","fixef"))
mod3.lswitch.upd <- update(mod3.lswitch,start=upd3.lswitch,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=20e4)))

# model comparison of lswitch models
anova(mod0.lswitch,mod0a.lswitch,mod1.lswitch,mod2.lswitch.upd,mod3.lswitch.upd)

######## more complex models with random + nested effects which did not all converge ##############################

#mod1b.correct <-glmer(Correct~Group*Cond*volat+(1|sub_idx)+(1|Cond/volat), data=data_new,family=binomial)
#mod1c.correct <- glmer(Correct~Group*Cond+(1|sub_idx), data=data_new,family=binomial, nAGQ = 0)

#mod1b.w_stay <-glmer(w_stay~Group*Cond*volat+(1|sub_idx)+(1|Cond/volat), data=data_new,family=binomial)
#mod1c.w_stay <-glmer(w_stay~Group*Cond+(1|sub_idx), data=data_new,family=binomial)

#mod1b.l_switch <-glmer(l_switch~Group*Cond*volat+(1|sub_idx)+(1|Cond/volat), data=data_new,family=binomial)

#mod2.w_stay <-glmer(w_stay~Group*Cond*volat+(Cond*volat|sub_idx), data=data_new,family=binomial)
#mod2.l_switch <-glmer(l_switch~Group*Cond*volat+(Cond*volat|sub_idx), data=data_new,family=binomial,nAGQ = 0)
#mod2.correct <-glmer(Correct~Group*Cond*volat+(Cond*volat|sub_idx), data=data_new,family=binomial)


``` 

## Post Hoc Tests
```{r}
# do post-hoc tests on simple models mod1a

emmip(mod2.HC.RT, aucg_scaled ~ volat)
emmip(mod1.HC.cond.correct, Cond)

emmip(mod3.correct, volat ~ Group | c(Cond,volat))

emmip(mod3.correct, volat ~ Cond | Group)

emmip(mod3.wstay, volat ~ Group | Cond)
emmip(mod3.lswitch, volat ~ Group | Cond)

correct.emm <- emmeans(mod3.correct,pairwise ~ Group | c(Cond,volat))

# do post-hoc tests on HC models
correct.emm <- emmeans(mod2.correct,~ volat | Cond)
winstay.emm <- emmeans(mod2.wstay,pairwise ~ volat | Cond)
loseswitch.emm <- emmeans(mod2.lswitch,pairwise ~ volat | Cond)
RT.emm <- emmeans(mod2.HC.cond.RT,pairwise ~ volat | Cond)


# test all contrasts
contrast(correct.emm,"consec",simple = "Cond", adjust = "bonferroni", ratios = TRUE, weights = "cells")
contrast(loseswitch.emm,"consec",simple = "Cond", adjust = "bonferroni", ratios = TRUE, weights = "cells")
contrast(winstay.emm, "consec",simple = "Cond", adjust = "bonferroni", ratios = TRUE, weights = "cells")

contrast(correct.emm,"consec", simple ="Group", combine = TRUE, adjust = "mvt",weights = "cells")
```
