---
title: "Methods Draft SALAD"
author: "Lara Wieland & Claudia Ebrahimi"
date: "12/2/2021"
output:
  html_document: default
  word_document: default
bibliography: SALAD.bib
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
rm(list = ls()) 

if (!require(ggplot2)) install.packages("ggplot2")
if (!require(lme4)) install.packages("lme4")
if (!require(corrplot)) install.packages("corrplot")
if (!require(PerformanceAnalytics)) install.packages("PerformanceAnalytics")
if (!require(kableExtra)) install.packages('kableExtra')
if (!require(Hmisc)) install.packages('Hmisc')
if (!require(gghalves)) install.packages('gghalves')
if (!require(parameters)) install.packages("parameters")
if (!require(insight)) install.packages("insight")
if (!require(broom.mixed)) install.packages("broom.mixed")


library("ggplot2")
library("lme4")
library("corrplot")
library("PerformanceAnalytics")
library("kableExtra")
library("Hmisc")
library("gghalves")
library("parameters") # nice PDF-friendly formatting of glm results
library("insight")
library("broom.mixed")

```


```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST: load behavioral data

load('/cloud/project/dataframes/dat.rda')
load('/cloud/project/dataframes/data.rda')
load('/cloud/project/dataframes/data_new_HC.rda')
load('/cloud/project/dataframes/data_prep.rda')
load('/cloud/project/dataframes/dat.nooutlier.rda')
load('/cloud/project/dataframes/data_params.rda')

load('/cloud/project/dataframes/data_physio_long.rda')
load('/cloud/project/dataframes/data_physio_clean.rda')
load('/cloud/project/dataframes/dat_physio_behav.rda')
load('/cloud/project/dataframes/data_physio_behav.rda')
load('/cloud/project/dataframes/dat_physio_behav_red.rda')
load('/cloud/project/dataframes/data_physio_behav_red.rda')

load('/cloud/project/dataframes/data_new_HC.rda')
load('/cloud/project/dataframes/data_prep.rda')

```

```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST 
source('preps/prep_agg.R')
source('preps/longtowide_agg.R')
```

## Methods

### Study Design

The study entailed a within-subjects design, in which participants performed the reversal learning task in two separate test sessions seven days apart. 

### Task Design

Participants performed a probabilistic reversal learning task, which included 160 trials and comprised around 12 minutes. The task was programmed in Matlab (The MathWorks, Natick, MA) with Psychtoolbox. On every trial, participants had to decide between two cards, depicting a different geometric stimulus. The underlying reward structure was not explicitly instructed but could be inferred: reward probabilites associated with the two choice options were anticorrelated (i.e. whenever card A was rewarded, card B was a loss and vice versa). Furthermore, Participants were informed on the probabilistic nature of the task: the respective winning card was only rewarded in 80% of all trials. Right-side versus left-side location of the stimulus was randomized [@Reiter2016].

#### Exemplary Reversal Learning Task


```{r fig1, echo = FALSE, out.width = "40%", fig.cap = "Adapted from Reiter (2016) (original [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6705653/))"}

knitr::include_graphics("images/reversal.png")

```



```{r task structure, include=T, echo = F}
# Task Structure

state_rev <- c(1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1, 1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2, 2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2,	2)

state_rev_2 <- replace(state_rev, state_rev==2, 0)

plot(state_rev_2,type = "o", col = "black", xlab = "Trial", ylab = "Outcome probability", main = "Contingencies")


```

### Physiological stress response

Saliva was collected using Salivette saliva sampling tubes (SalivetteCortisolÂ®, Sarstedt, Nuembrecht, Germany) to extract and measure salivary cortisol. Physiologically relevant cortisol increases were defined at a threshold of 1.5nmol per liter (nmol/l) increase post-stress (t3 through t6) above the lowest pre-stress level (t1 or t2) during the stress condition as described previously [@Radenbach2015]. Individual cortisol reactivity was determined by calculating the area under the curve with respect to ground (AUCg-stress and AUCg-control, according to Pruessner et al., 2003) separately for both conditions and subtracting AUCg-control from AUCg-stress. 

### Stress Induction

```{r stress induction, include=T, echo=F,results = 'hide', error=FALSE, warning=FALSE}

data_physio_long.HC <- data_physio_long %>%  filter(Gruppe == "Control", marker == "amyl")
#data_physio_long.HC <- data_physio_long %>%  filter(Gruppe == "Control", marker == "cort")

# Claudia's function se that calculates the standard errors
se <- function(x) sd(x, na.rm=TRUE)/sqrt(length(x)-sum(is.nan(x)))

time_means <- data_physio_long.HC %>%
    group_by(variable_name,time,condition) %>%
    summarise(Mean = mean(value, na.rm = TRUE),SE = se(value)) %>% data.frame()

# TSST effect
tsst_plot <- 
  ggplot(time_means, aes(x=time,y=Mean, color = condition)) + geom_point() + geom_line() +      
  geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE),width=.2) +
  scale_color_manual(values = c("#00BFC4", "#F8766D")) +
  scale_x_continuous(breaks=c(1,2,3,4,5,6), labels=c("T1 (-30)", "T2 (-2)", "T3 (+10)","T4 (+15)","T5 (+30)","T6 (45)"), limits=c(0.5, 7)) +
  #scale_y_continuous(limits=c(0,11)) +
  scale_y_continuous(limits=c(100,350)) +
  # annotate("rect", xmin = 2.2, xmax = 3, ymin = 0, ymax = 11, fill="turquoise", alpha = .2) +
  # annotate("rect", xmin = 4, xmax = 5, ymin = 0, ymax = 11, fill="darkgrey", alpha = .2) +
  annotate("rect", xmin = 2.2, xmax = 3, ymin = 100, ymax = 350, fill="turquoise", alpha = .2) +
  annotate("rect", xmin = 4, xmax = 5, ymin = 100, ymax = 350, fill="darkgrey", alpha = .2) +
   xlab("Time Point") + ylab("Amylase activity in saliva in U/ml") +
   labs(title = 'Alpha-amylase stress response over the course of experimental session',
        subtitle = 'Clear effect of stress condition',
        col = "Condition") + 
   theme(plot.title = element_text(face = "italic"))
   theme_classic()
tsst_plot

ggsave(tsst_plot, filename = "perc_wstay_HC.png","jpg", "/cloud/project/plots/committee_plots")

# paired ttest for AUC ST vs. CT: significant difference
auc.cort.ttest <- stats::t.test(data_physio_behav_red$aucg_control, data_physio_behav_red$aucg_stress, paired = TRUE)
auc.amyl.ttest <- stats::t.test(data_physio_behav_red$aucg_amyl_control, data_physio_behav_red$aucg_amyl_stress, paired = TRUE)

# paired ttest for pre-stress cortisol between ST and CT: no significant difference
auc.T1cort.ttest <- stats::t.test(dat_physio_behav$t1_cort_control, dat_physio_behav$t1_cort_stress, paired = TRUE)
```

```{r, include=T,message=FALSE, echo=F, results = 'hide',error=FALSE,warning=FALSE}
#[(beta=``r mod1.HC.correct@beta[1]`).``r resul$lower.random``; ``r resul$upper.random``], z=``r resul$zval.random``, p=``r resul$pval.random``, see Figure x). 
longdat.correct$jvolat2 <- jitter(longdat.correct$volat2, amount=.09)
longdat.HC.correct$jvolat2 <- jitter(longdat.HC.correct$volat2, amount=.09)
longdat.AD.correct$jvolat2 <- jitter(longdat.AD.correct$volat2, amount=.09)

f3_pcorrect_HC <- ggplot(data=longdat.HC.correct, aes(y=p_correct)) +

   #Add geom_() objects
   geom_point(data = longdat.HC.correct %>% filter(cond2=="1"), aes(x=jvolat2), color = '#00BFC4', size = 1.5,
              alpha = .6) +
      geom_point(data = longdat.HC.correct %>% filter(cond2=="0"), aes(x=jvolat2), color = '#F8766D', size = 1.5,
              alpha = .6) +

   geom_line(aes(x=jvolat2, group=sub_id), color = 'lightgray', alpha = .3) +

        geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="pre_ST"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#F8766D') +

      geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="rev_ST"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#F8766D') +

      geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="post_ST"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#F8766D') +

     geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="pre_CT"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#00BFC4') +

      geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="rev_CT"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#00BFC4') +

      geom_half_boxplot(
     data = longdat.HC.correct %>% filter(volat1=="post_CT"), aes(x=jvolat2, y=p_correct), position = position_nudge(x = -.3),
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2,
     fill = '#00BFC4') +
   #Define additional settings
   scale_x_continuous(breaks=c(1,2,3,4,5,6), labels=c("Stress_pre", "Stress_rev", "Stress_post","Control_pre","Control_rev","Control_post")) +
   xlab("Condition") + ylab("Percentage of correct responses") +
   labs(title = 'Expected task effect: performance decreased in reversal phase',
           subtitle = 'Condition by phase',
           caption = 'Datapoints are jittered') +
   theme(plot.title = element_text(face = "italic"))
   theme_classic()

f3_pcorrect_HC

```

### Behavioral Analyses

The statistical software R (version 3.6.3; R Foundation for Statistical Computing, Vienna, Austria) with the lme4 package (@Bates2015) for generalized linear mixed-effects models [@Bates2015] was used. Task phase, condition day (CT/ST) and cortisol were modeled as fixed effects, subjects with a random intercept and outcome variables of correct performance, win-stay behavior and lose-switch-behavior.

### Modeling

For modeling underlying learning processes individually, we used the novel cbm-Toolbox, which relies on hierarchical Bayesian inference for concurrent model-fitting. In this toolbox individual model fits affect the parameter estimation: In case of good model fit for a subject, its parameter estimates will affect group priors more strongly than in the case of bad fit.

A comprehensive model space including single-update (1), double-update (2), and individual double update-learning (3), each with one or two learning rates (separate for wins and losses) in combination with a softmax and two inverse temperature parameters (separate for wins and losses) was applied. (@Reiter2016)

## Results

```{r, include=T,echo=F,results = 'hide', error=FALSE, warning=FALSE}
## NECESSARY TO RUN THIS FIRST:
load('/cloud/project/dataframes/data_new_HC.rda')
load('/cloud/project/dataframes/data_prep.rda')
```


```{r, include=T,echo=F,results = 'hide', error=FALSE, warning=FALSE}
which(!data_new_HC$RT == 0)
excl_row <- row(data_new_HC)[which(!data_new_HC$RT != 0)]

# calculate perc of trials excluded
perc_excl <- (length(excl_row)/nrow(data_new_HC))*100

# exclude trials with RT = 0 because they are NaN for w_stay and l_switch as well
data_new_HC <- data_new_HC %>% filter(RT!=0)

# contrasts(data_new_HC$Group) <- c(0.5,-0.5)
contrasts(data_new_HC$Cond) <- c(-0.5,0.5)
contrasts(data_new_HC$volat) <- cbind(c1 = c(1/3,-2/3,1/3), c2 = c(1/3,1/3,-2/3))

# hypr object containing 2 null hypotheses, volat1 vs. volat2 and volat1 vs. volat3 while contrasts still add to 0:
# H0.1: 0 = X1 - X2
# H0.2: 0 = X1 - X3

# Cond factor: 1 = control, 2 = stress
# F1 (control) = -0.5, F2 (stress) = 0.5 which means that 
# ein Einheit von CT - ST wird durch Beta kodiert
# estim. value for F1 = Intercept - 0.5* Slope(F1) 1.13 = 1.19 - 0.5*0.12
# estim. value for F2 = Intercept + 0.5* Slope(F1) 1.25 = 1.19 + 0.5*0.12

# CHANGE HERE scale zpeak_cort or zpeak_amyl or aucg variable to avoid convergence issues

data_new_HC$aucg_scaled <- scale(data_new_HC$aucg)
#data_new_HC$zpeak_scaled <- scale(data_new_HC$zpeak)
#data_new_HC$zpeak_scaled <- scale(data_new_HC$zpeak_amyl)

# - in a model with Correct predicted by random subject intercept (0) + covariates (0a)
# - in a model with Correct predicted by random subject intercept + all main effects (1)
# - in a model with Correct predicted by random subject intercept + all main effects + 2-way-interaction effect (2)
mod0.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
#mod0a.HC.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.correct <- glmer(Correct~aucg_scaled+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.correct <- glmer(Correct~aucg_scaled*volat+(1|sub_idx), data=data_new_HC,family=binomial)

anova(mod0.HC.correct, mod0a.HC.correct,mod1.HC.correct,mod2.HC.correct)

mod0.HC.cond.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC, family=binomial)
#mod0a.HC.cond.correct <- glmer(Correct~(1|sub_idx), data=data_new_HC,family=binomial)
mod1.HC.cond.correct <- glmer(Correct~Cond+volat+(1|sub_idx), data=data_new_HC,family=binomial)
mod2.HC.cond.correct <- glmer(Correct~Cond*volat+(1|sub_idx), data=data_new_HC,family=binomial)

anova(mod0.HC.cond.correct, mod0a.HC.cond.correct,mod1.HC.cond.correct,mod2.HC.cond.correct)

```

```{r, include=T,echo=F, error=FALSE, warning=FALSE}
sjPlot::plot_model(mod1.HC.correct,show.values=TRUE, show.p=TRUE, axis.labels = c("Stable Phase","Reversal Phase","Cortisol Effect"))

sjPlot::plot_model(mod1.HC.cond.correct,show.values=TRUE, show.p=TRUE, axis.labels = c("Stable Phase","Reversal Phase","Condition Effect"))

sjPlot::tab_model(mod1.HC.correct, 
                  show.re.var= TRUE, 
                  pred.labels =c("Intercept", "AUC Cortisol (Stress)", "Reversal Phase", "Stable Phase"))

sjPlot::tab_model(mod1.HC.cond.correct, 
                  show.re.var= TRUE, 
                  pred.labels =c("Intercept", "Condition (Stress Day)", "Reversal Phase", "Stable Phase"))

sjPlot::plot_model(mod1.HC.cond.correct,show.values=TRUE, show.p=TRUE, auto.label = FALSE)

sjPlot::tab_model(mod1.HC.cond.correct, 
                  show.intercept = TRUE, show.est = TRUE, show.se = TRUE, show.stat = TRUE, show.df = TRUE,
                  pred.labels =c("Intercept", "Condition", "Reversal Phase", "Stable Phase"))

sjPlot::tab_model(mod1.HC.cond.correct, 
                  show.se = TRUE, show.stat = TRUE,show.est = TRUE, 
                  pred.labels =c("Intercept", "Condition", "Reversal Phase", "Stable Phase"))

mod1.HC.correct %>%
  tidy(conf.int = TRUE) %>%
  # parenthesis look better in markdown-tables, so we use "brackets" here
  format_table(ci_brackets = c("(", ")")) %>%
  export_table(format = "markdown", caption = "Mixed-effects modeling results", align = "lcccrr")

model_parameters(mod1.HC.correct) %>% print_md()


```

### References