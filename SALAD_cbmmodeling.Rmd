---
title: "SALAD_cbmmodeling"
author: "Lara Wieland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fig_caption: yes
---

This script:
- loads necessary packages
- imports data (data_params: summary of 6 (or 8 if you count scaling+beta) free parameters exported from Matlab cbm section 6
                dat_physio_behav: most of behavioral data + physio data in wide format for AD + HC sample
                data_physio_behav: same but only HC sample)
- check parameter distributions and 
- plots exploratory analyses on WM capacity mediating cortisol impact on behavioral performance (p_correct)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
rm(list = ls()) 

if (!require(ggplot2)) install.packages("ggplot2")
if (!require(lme4)) install.packages("lme4")
if (!require(corrplot)) install.packages("corrplot")
if (!require(PerformanceAnalytics)) install.packages("PerformanceAnalytics")
if (!require(kableExtra)) install.packages('kableExtra')
if (!require(Hmisc)) install.packages('Hmisc')
if (!require(sjmisc)) install.packages('sjmisc')
if (!require(ggpubr)) install.packages("ggpubr")

library("ggplot2")
library("lme4")
library("corrplot")
library("PerformanceAnalytics")
library("kableExtra")
library("Hmisc")
library("sjmisc")
library("ggpubr")

```

# Data Import
```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST:

load('/cloud/project/dataframes/dat_physio_behav.rda')
load('/cloud/project/dataframes/data_physio_behav.rda')
load('/cloud/project/dataframes/dat_physio_behav_red.rda')
load('/cloud/project/dataframes/data_physio_behav_red.rda')
load('/cloud/project/dataframes/data_params.rda')

```


## Modeling Preparations and Checks
```{r}

# dichotomize HC dataset by WM capacity (num_backward)
data_physio_behav$wm_cap <- dicho(data_physio_behav$num_backward, dich.by = "median", as.num = TRUE)
data_physio_behav$wm_cap <-factor(data_physio_behav$wm_cap, labels=c("low WM", "high WM"))

# dichotomize HC dataset by lifetime stress (PSS)
data_physio_behav$lt_stress <- dicho(data_physio_behav$PSS_Total, dich.by = "median", as.num = TRUE)
data_physio_behav$lt_stress <-factor(data_physio_behav$lt_stress, labels=c("low lifetime stress", "high lifetime stress"))

# calculate the difference between individual p_correct values (ST-CT) for single phases and all
data_physio_behav <- mutate(data_physio_behav, diff_STCT_pre = p_correct_pre_ST - p_correct_pre_CT)
data_physio_behav <- mutate(data_physio_behav,m_diff_STCT_pre = mean(diff_STCT_pre))

data_physio_behav <- mutate(data_physio_behav, diff_STCT_rev = p_correct_rev_ST - p_correct_rev_CT)
data_physio_behav <- mutate(data_physio_behav,m_diff_STCT_rev = mean(diff_STCT_rev))

data_physio_behav <- mutate(data_physio_behav, diff_STCT_post = p_correct_post_ST - p_correct_post_CT)
data_physio_behav <- mutate(data_physio_behav,m_diff_STCT_post = mean(diff_STCT_post))

data_physio_behav <- mutate(data_physio_behav, diff_STCT = p_correct_ST - p_correct_CT)

median_params <- data_params %>% summarise_if(is.numeric, median)
sd_params <- data_params %>% summarise_if(is.numeric, sd)

params_sum <- rbind(median_params, sd_params)

# find and exclude outliers
data_physio_behav %>% 
  # select the variable of interest
  select(bet_win) %>% 
  # the function scale() transforms your values to z-scores
  scale() %>% 
  # sort the z-values in ascending order to find the extremes more easily
  sort()

data_physio_behav$zbet_win <- data_physio_behav %>% 
  # select the variable of interest
  select(bet_win) %>% 
  # the function scale() transforms your values to z-scores
  scale() %>% 
  # sort the z-values in ascending order to find the extremes more easily
  sort()
# Distribution of parameters: separated because of different ranges

# wide to long
data_params_al <- data_params %>% select(c("al_win","al_loss"))
data_params_bet <- data_params %>% select(c("bet_win","bet_loss","sc_bet_win","sc_bet_loss"))
data_params_sc <- data_params %>% select(c("sc_win","sc_loss"))

data_params_bet <- tibble::rowid_to_column(data_params_bet, "sub_idx")
data_params_al <- tibble::rowid_to_column(data_params_al, "sub_idx")

data_params_long_bet <- data_params_bet %>% 
  gather(key = "Parameter", value = "ParameterValue", -sub_idx)
data_params_long_bet

data_params_long_al <- data_params_al %>% 
  gather(key = "Parameter", value = "ParameterValue", -sub_idx)
data_params_long_al

bet_cov_prep <- data_physio_behav %>% select("sub_id","bet_win","bet_loss","sc_bet_win","sc_bet_loss")
save(file='/cloud/project/dataframes/bet_cov_prep.rda',bet_cov_prep)
bet_cov_prep <- load('/cloud/project/dataframes/bet_cov_prep.rda')
write.csv(get(bet_cov_prep), file='/cloud/project/fmri/bet_cov_prep.csv')

# make violin plots to show distribution
p.betviol <- ggplot(data_params_long_bet, aes(x = Parameter, y = ParameterValue)) + geom_violin(trim = TRUE)  + stat_summary(fun=median, geom="point", size=2, color="red") + geom_jitter(shape=16, position=position_jitter(0.2)) 
p.betviol

p.alviol <- ggplot(data_params_long_al, aes(x = Parameter, y = ParameterValue)) + geom_violin(trim = TRUE) + stat_summary(fun=median, geom="point", size=2, color="red") + geom_jitter(shape=16, position=position_jitter(0.2)) 
p.alviol

ggsave(p.betviol, filename = "betviol.png","jpg", "/cloud/project/plots/committee_plots")
ggsave(p.alviol, filename = "alviol.png","jpg", "/cloud/project/plots/committee_plots")

##################### CORRELATION MODELING params with each other

res2 <- rcorr(as.matrix(data_params))

res <- cor(data_params)

corrplot(res2$r,method = "number", type="upper", 
         p.mat = res2$P, sig.level = 0.05, insig = "blank")

chart.Correlation(data_params)

```

```{r}

##################### MODELING and BEHAV p_correct 
# calculate from modeling params beta parameters + scaling factor

data_physio_behav <- data_physio_behav  %>% mutate(bet_ST_loss = abs(bet_loss) + abs(sc_bet_loss))
data_physio_behav <- data_physio_behav  %>% mutate(bet_ST_win = abs(bet_win) + abs(sc_bet_win))

data_physio_behav.nooutlier <- data_physio_behav %>% filter(zbet_win < 3)

# plots for modeling params of DU_scaling_bothCond (winning model with different betas for ST vs. CT) and p_correct
mod_pcorrect_plot_1 <- ggscatter(data_physio_behav.nooutlier, x = "bet_win", y = "diff_STCT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta Win", ylab = "Difference ST-CT")
mod_pcorrect_plot_1

mod_pcorrect_plot_2 <- ggscatter(data_physio_behav.nooutlier, x = "bet_loss", y = "diff_STCT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta Loss", ylab = "Difference ST-CT") 
mod_pcorrect_plot_2

mod_pcorrect_plot_3 <- ggscatter(data_physio_behav.nooutlier, x = "sc_bet_win", y = "diff_STCT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Scaling Beta Win", ylab = "Difference ST-CT") 
mod_pcorrect_plot_3

mod_pcorrect_plot_4 <- ggscatter(data_physio_behav.nooutlier, x = "sc_bet_loss", y = "diff_STCT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Scaling Beta Loss", ylab = "Difference ST-CT")
mod_pcorrect_plot_4

# scaling beta + beta = ST correlated with p_correct ST; just beta correlated with p_correct CT

mod_pcorrect_plot_5 <- ggscatter(data_physio_behav.nooutlier, x = "sc_bet_win", y = "p_correct_ST",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta + Beta Scaling Win", ylab = "Correct Performance ST")
mod_pcorrect_plot_5

mod_pcorrect_plot_6 <- ggscatter(data_physio_behav.nooutlier, x = "sc_bet_loss", y = "p_correct_ST",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta + Beta Scaling Loss", ylab = "Correct Performance ST")
mod_pcorrect_plot_6

mod_pcorrect_plot_7 <- ggscatter(data_physio_behav.nooutlier, x = "bet_win", y = "p_correct_CT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta Win", ylab = "Correct Performance CT")
mod_pcorrect_plot_7

mod_pcorrect_plot_8 <- ggscatter(data_physio_behav.nooutlier, x = "bet_loss", y = "p_correct_CT",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Beta Loss", ylab = "Correct Performance CT")
mod_pcorrect_plot_8

mod_pcorrect_plot_9 <- ggscatter(data_physio_behav, x = "sc_bet_win", y = "p_correct_ST",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Scaling + Beta Win", ylab = "Correct Performance ST")
mod_pcorrect_plot_9

mod_pcorrect_plot_10 <- ggscatter(data_physio_behav, x = "sc_bet_loss", y = "p_correct_ST",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Scaling + Beta Loss", ylab = "Correct Performance ST")
mod_pcorrect_plot_10

# ttest for scaling against 0
scwin.ttest <- stats::t.test(data_params$sc_win)
scloss.ttest <- stats::t.test(data_params$sc_loss)

# ttest for scaling plus betas against 0
scbetwin.ttest <- stats::t.test(data_params$sc_bet_win)
scbetloss.ttest <- stats::t.test(data_params$sc_bet_loss)

# ttest for betas against 0
betwin.ttest <- stats::t.test(data_params$bet_win)
betloss.ttest <- stats::t.test(data_params$bet_loss)

# paired ttest for betas with and w/o scaling against each other
pairedwin.ttest <- stats::t.test(data_params$bet_win,data_params$sc_win, paired = TRUE)
pairedloss.ttest <- stats::t.test(data_params$bet_loss,data_params$sc_loss, paired = TRUE)

pairedwinlossbet.ttest <- stats::t.test(data_params$bet_win,data_params$bet_loss, paired = TRUE)
pairedwinlossal.ttest <- stats::t.test(data_params$al_win,data_params$al_loss, paired = TRUE)

# Cortisol difference correlated with scaling factors

p.mod.cortscloss <- ggscatter(data_physio_behav, x = "aucg_diff", y = "sc_loss", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cortisol difference", ylab = "Scaling Loss")
p.mod.cortscloss

p.mod.cortscwin <- ggscatter(data_physio_behav, x = "aucg_diff", y = "sc_win", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cortisol difference", ylab = "Scaling Win")
p.mod.cortscwin

```


## Neuropsychology and Modeling Parameters
```{r}

neuropsych_params <- select(data_physio_behav,tmt_a, tmt_b, dsst, num_forward, num_backward, IQ_WST, al_win, al_loss, bet_win, bet_loss, sc_win, sc_loss, sc_bet_win, sc_bet_loss)

res3 <- rcorr(as.matrix(neuropsych_params))

corrplot(res3$r,method = "color", type="upper", 
         p.mat = res3$P, sig.level = 0.05, insig = "blank")


p.mod.betiq1 <- ggscatter(data_all, x = "IQ_WST", y = "bet_win", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cognitive capacities", ylab = "Inverse decision temperature (beta win)")
p.mod.betiq1

p.mod.betiq2 <- ggscatter(data_all, x = "IQ_WST", y = "bet_loss", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Cognitive capacities", ylab = "Inverse decision temperature (beta loss)")
p.mod.betiq2

```
