---
title: "SALAD analyses of cortisol data"
author: "Lara Wieland"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fig_caption: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aggregated Data Import
```{r}
## NECESSARY TO RUN THIS FIRST
source('preps/data_import.R')

```
# Aggregated Data Prep
```{r, include=FALSE}
## NECESSARY TO RUN THIS FOR LATER RMANOVA ANALYSES (all markdowns in analyses folder)
source('preps/prep_agg.R')

```
# Cortisol Data Prep
```{r, include=FALSE}
## NECESSARY TO RUN THIS FIRST
source('preps/prep_cort.R')

```

## Calculate Cortisol Peaks and AUC Ground = calculated according to Pruessner (2003) formula: 
```{r, echo=FALSE}
# create basic histograms to check distribution of cortisol

data_physio_clean.HC <- data_physio_clean %>% filter(Gruppe == "Control")

hist(data_physio_clean$t1_cort)
hist(data_physio_clean$t2_cort)
hist(data_physio_clean$t3_cort)
hist(data_physio_clean$t4_cort)
hist(data_physio_clean$t5_cort)
hist(data_physio_clean$t6_cort)

hist(data_physio_clean$peak_cort)
hist(data_physio_clean$aucg)

# time intervals in our study design: t1-t2:28 min, t2-t3: 12 min, t3-t4: 5 min, t4-t5: 15 min, t5-t6: 15 min

data_physio_clean$aucg <- ((data_physio_clean$t2_cort+data_physio_clean$t1_cort)*28)/2 + ((data_physio_clean$t3_cort + data_physio_clean$t2_cort)*12)/2 + ((data_physio_clean$t4_cort + data_physio_clean$t3_cort)*5)/2 + ((data_physio_clean$t5_cort + data_physio_clean$t4_cort)*15)/2 + ((data_physio_clean$t6_cort + data_physio_clean$t5_cort)*15)/2

# calculate and standardize cortisol by T4-T2 = peak_cort
data_physio_clean <- mutate(data_physio_clean, peak_cort = t4_cort-t2_cort)
  
z.peak_cort = (data_physio_clean$peak_cort-mean(data_physio_clean$peak_cort,na.rm=TRUE)/sd(data_physio_clean$peak_cort,na.rm=TRUE)) #ODER scale(peak_cort)
data_physio_clean$z.peak_cort <- z.peak_cort

# turn it into wide format, by condition
melted <- melt(data_physio_clean, id.vars= c("VpNr", "condition"))
data_wide <- dcast(melted,  VpNr ~ variable + condition)

# merge cortisol data with dat by sub_id
names(data_wide)[names(data_wide) == "VpNr"] <- "sub_id"
names(data_physio_clean)[names(data_physio_clean) == "VpNr"] <- "sub_id"
data_wide$sub_id <- as.character(data_wide$sub_id)
#CHANGE HERE
dat_all_reduced$sub_id <- str_remove(dat_all_reduced$sub_id, "[_]")
data_all$sub_id <- str_remove(data_all$sub_id, "[_]")

# merge wide physio dataset with reduced behavioral performance data set and turn everything into numerics apart from the descriptive first six rows
dat_physio_behav <- merge(data_wide, data_all, by = "sub_id", all.y = TRUE)

#CHANGE HERE
#dat_physio_behav <- merge(data_wide, dat_all_reduced, by = "sub_id", all.y = TRUE)
dat_physio_behav[,6:65] <- sapply(dat_physio_behav[,6:65],as.numeric)

data_physio_behav_red =subset(dat_physio_behav, select =-c(Gruppe_control,Gruppe_stress,day_order_control,day_order_stress,excluded,t1_cort_control,t2_cort_control,t3_cort_control,t4_cort_control,t5_cort_control,t6_cort_control,t1_amyl_control,t2_amyl_control,t3_amyl_control,t4_amyl_control,t5_amyl_control,t6_amyl_control,t1_cort_stress,t2_cort_stress,t3_cort_stress,t4_cort_stress,t5_cort_stress,t6_cort_stress,t1_amyl_stress,t2_amyl_stress,t3_amyl_stress,t4_amyl_stress,t5_amyl_stress,t6_amyl_stress,p_correct_CT,p_stay_CT,p_switch_CT,p_win_stay_CT,p_win_switch_CT,p_lose_stay_CT,p_lose_switch_CT,mean_RT_ST,mean_RT_CT,p_correct_ST,p_stay_ST,p_switch_ST,p_win_stay_ST,p_win_switch_ST,p_lose_stay_ST,p_lose_switch_ST))

# convert to fully long by 
data_physio_long <- data_physio_clean %>% melt(data_physio_clean, id.vars=c("sub_id","condition","Gruppe","day_order"), measure.vars = c("t1_cort","t2_cort","t3_cort","t4_cort","t5_cort","t6_cort","t1_amyl","t2_amyl","t3_amyl","t4_amyl","t5_amyl","t6_amyl"), variable.name = "variable_name")
n<-length(unique(data_physio_clean$sub_id))
data_physio_long$time <-rep(c(1:6),each=2*n)
data_physio_long$marker <- rep(c("cort","amyl"),each=2*6*n)

#names(data_physio_behav_1) = gsub(pattern = "_3*", replacement = "", x = names(data_physio_behav_1))

# "t1_cort_control","t2_cort_control","t3_cort_control","t4_cort_control","t5_cort_control","t6_cort_control","t1_amyl_control","t2_amyl_control","t3_amyl_control","t4_amyl_control","t5_amyl_control","t6_amyl_control","peak_cort_control","z.peak_cort_control","t1_cort_stress","t2_cort_stress","t3_cort_stress","t4_cort_stress","t5_cort_stress","t6_cort_stress","t1_amyl_stress","t2_amyl_stress","t3_amyl_stress","t4_amyl_stress","t5_amyl_stress","t6_amyl_stress","peak_cort_stress","z.peak_cort_stress","p_correct_CT","p_stay_CT","p_switch_CT","p_win_stay_CT","p_win_switch_CT","p_lose_stay_CT","p_lose_switch_CT","mean_RT_ST","p_correct_ST","p_stay_ST","p_switch_ST","p_win_stay_ST","p_win_switch_ST","p_lose_stay_ST","p_lose_switch_ST",

# data_all_long <- dat_physio_behav %>% melt(dat_physio_behav, id.vars=c("sub_id","Gruppe_control","day_order_control"), measure.vars = c("diff_STCT_pre","diff_STCT_rev", "diff_STCT_post"), variable.name = "phase")
# 
# data_diff_long <- dat_physio_behav %>% melt(data_physio_clean, id.vars=c("sub_id","Gruppe_control","day_order_control"), measure.vars = c("diff_STCT_pre","diff_STCT_rev", "diff_STCT_post"), variable.name = "phase")
# 
# data_diff_long <- data_all_long %>% arrange(sub_id)
# 
# data_diff_long$phase <- as.factor(data_diff_long$phase)
# 
# data_diff_long.HC <- data_diff_long %>%
# filter(Gruppe_control=="Control")
# 
# ggplot(data_diff_long.HC, aes(x=phase, y=value)) + 
#   geom_boxplot(aes(middle = mean(value))) + #avoid plotting outliers twice
#   geom_jitter(position=position_jitter(width=.1, height=0))

```


## Cortisol Analyses Plots
```{r}

dat_physio_behav.HC <- dat_physio_behav %>%
filter(Gruppe_control=="Control")


# two separate plots: 1) y= p_correct_ST x = z_peak_cort_ST 2) y = p_correct_CT x = z_peak_cort_CT
# all in one plot: y= p_correct, z = z_peak_cort, color= condition
#dat_physio_behav_2 <- dat_physio_behav_1 %>% drop_na(peak_cort_control)

# in whole sample
physio_plot1 <- ggscatter(dat_physio_behav, x = "p_correct_ST", y = "z.peak_cort_stress", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Correct Responses (ST)", ylab = "Cortisol Peak (ST)")
physio_plot1

# only HC
physio_plot2 <-  ggscatter(dat_physio_behav.HC, x = "p_correct_ST", y = "z.peak_cort_stress", na.rm = TRUE,
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Correct Responses (ST)", ylab = "Cortisol Peak (CT)")
physio_plot2

physio_plot3 <-  ggscatter(dat_physio_behav.HC, x = "p_correct_ST", y = "aucg_stress", na.rm = TRUE,
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Correct Responses (ST)", ylab = "AUC Cortisol (ST)")
physio_plot3

physio_plot4 <-  ggscatter(dat_physio_behav.HC, x = "p_win_stay_ST", y = "aucg_stress", na.rm = TRUE,
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Win Stay Behavior (ST)", ylab = "AUC Cortisol (ST)")
physio_plot4

physio_plot5 <-  ggscatter(dat_physio_behav.HC, x = "p_lose_switch_ST", y = "aucg_stress", na.rm = TRUE,
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Lose Switch Behavior (ST)", ylab = "AUC Cortisol (ST)")
physio_plot5

```

## Exploratory Analyses: WM-Median Split - Cortisol - Performance (inspired by Otto,2013)
```{r}

# dichotomize HC dataset by WM capacity (num_backward)
dat_physio_behav$wm_cap <- dicho(dat_physio_behav$num_backward, dich.by = "median", as.num = TRUE)
dat_physio_behav$wm_cap <-factor(dat_physio_behav$wm_cap, labels=c("low WM", "high WM"))


# plots correct performance onto cortisol stress level in both conditions
wm_plot <- 
  ggplot(longdat.cond.both, aes(aucg,p_correct, color = wm_cap)) + geom_point() + geom_smooth(aes(group = wm_cap), method = "lm", se = FALSE) + facet_wrap(~cond2)
wm_plot

wm_plot_cond <- 
  ggplot(longdat.cond.both, aes(aucg,p_correct)) + geom_point() + geom_smooth(aes(group = cond2), method = "lm", se = FALSE) + facet_wrap(~cond2)
wm_plot_cond


longdat.cond.phys <- melt(dat_physio_behav,
        # ID variables - all the variables to keep but not split apart on
    id.vars=c("sub_id","wm_cap"),
        # The source columns
    measure.vars=c("aucg_control","aucg_stress"),
        # Name of the destination column that will identify the original
        # column that the measurement came from
    variable.name="cond",
    value.name="aucg"
)

longdat.cond.correct <- melt(data_all,
                        # ID variables - all the variables to keep but not split apart on
                        id.vars=c("sub_id"),
                        # The source columns
                        measure.vars=c("p_correct_ST","p_correct_CT"),
                        # Name of the destination column that will identify the original
                        # column that the measurement came from
                        variable.name="cond",
                        value.name="p_correct"
)

# extract string ST or CT from phase strings and turn it into logical, then numeric
longdat.cond.correct <- longdat.cond.correct %>% mutate(cond = grepl("*CT",longdat.cond.correct$cond)) 
longdat.cond.correct <- longdat.cond.correct %>% mutate(cond2 = longdat.cond.correct$cond*1) %>% rename(cond = longdat.cond.correct$cond2)
longdat.cond.correct$cond2<-factor(longdat.cond.correct$cond2, labels=c("stress", "control"))

library(plyr)
longdat.cond.phys$cond2 <- revalue(longdat.cond.phys$cond, c("aucg_control" = "control","aucg_stress"="stress"))

revalue(x, c("beta"="two", "gamma"="three"))
#> [1] alpha two   three alpha two  

longdat.cond.phys$sub_id <- factor(longdat.cond.phys$sub_id)
longdat.cond.correct$sub_id <- factor(longdat.cond.correct$sub_id)

longdat.cond.both <- merge.data.frame(longdat.cond.phys,longdat.cond.correct, by = c("sub_id", "cond2"))

longdat.physbehav3.low <- longdat.physbehav3 %>% filter(wm_cap == "0")
longdat.physbehav3.high <- longdat.physbehav3 %>% filter(wm_cap == "1")


low_wm_plot <-
   ggplot(longdat.physbehav3.low, aes(aucg_control,p_correct_CT, color = )) + geom_point() + geom_smooth(aes(group = wm_cap), method = "lm", se = FALSE)

```